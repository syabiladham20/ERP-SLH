{% extends 'base.html' %}

{% block content %}
<h2>{{ 'Edit Daily Log' if log else 'Daily Data Entry' }}</h2>

{% if not houses and not log %}
  <div class="alert alert-warning">
    No active flocks found. Please <a href="{{ url_for('manage_flocks') }}">create a flock</a> first.
  </div>
{% else %}
  <form method="POST" enctype="multipart/form-data">
    <div class="card mb-3">
      <div class="card-header bg-primary text-white">General Info</div>
      <div class="card-body">
        <div class="mb-3">
          <label for="house_id" class="form-label">House</label>
          {% if log %}
            <input type="text" class="form-control" value="{{ houses[0].name }}" disabled>
            <input type="hidden" name="house_id" value="{{ houses[0].id }}">
            <input type="hidden" id="phase_val" value="{{ log.flock.phase }}">
          {% else %}
            <select class="form-select" id="house_id" name="house_id" required onchange="updatePhase()">
              {% for house in houses %}
                {# Pass phase info in data attribute #}
                {% set flock = house.flocks|selectattr("status", "equalto", "Active")|first %}
                <option value="{{ house.id }}" data-phase="{{ flock.phase if flock else 'Rearing' }}">{{ house.name }}</option>
              {% endfor %}
            </select>
          {% endif %}
        </div>
        <div class="mb-3">
          <label for="date" class="form-label">Date</label>
          <input type="date" class="form-control" id="date" name="date" required value="{{ log.date if log else date_today }}" {{ 'disabled' if log else '' }}>
        </div>
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-header bg-info text-dark">Mortality, Culls & Transfers</div>
      <div class="card-body">
        <h5 class="card-title">Production (Male & Female)</h5>
        <div class="row">
          <div class="col-6 mb-2">
            <label class="form-label">Mortality Male (Prod)</label>
            <input type="number" class="form-control" name="mortality_male" value="{{ log.mortality_male if log else 0 }}">
          </div>
          <div class="col-6 mb-2">
            <label class="form-label">Mortality Female</label>
            <input type="number" class="form-control" name="mortality_female" value="{{ log.mortality_female if log else 0 }}">
          </div>
          <div class="col-6 mb-2">
            <label class="form-label">Culls Male (Prod)</label>
            <input type="number" class="form-control" name="culls_male" value="{{ log.culls_male if log else 0 }}">
          </div>
          <div class="col-6 mb-2">
            <label class="form-label">Culls Female</label>
            <input type="number" class="form-control" name="culls_female" value="{{ log.culls_female if log else 0 }}">
          </div>
        </div>

        <hr>
        <h5 class="card-title">Male Hospital (Optional)</h5>
        <div class="row">
          <div class="col-6 mb-2">
            <label class="form-label">Mortality Male (Hosp)</label>
            <input type="number" class="form-control" name="mortality_male_hosp" value="{{ log.mortality_male_hosp if log else 0 }}">
          </div>
          <div class="col-6 mb-2">
            <label class="form-label">Culls Male (Hosp)</label>
            <input type="number" class="form-control" name="culls_male_hosp" value="{{ log.culls_male_hosp if log else 0 }}">
          </div>
        </div>

        <hr>
        <h5 class="card-title">Male Transfers</h5>
        <div class="row">
           <div class="col-6 mb-2">
            <label class="form-label">Moved TO Hospital</label>
            <input type="number" class="form-control" name="males_moved_to_hosp" value="{{ log.males_moved_to_hosp if log else 0 }}">
          </div>
          <div class="col-6 mb-2">
            <label class="form-label">Moved TO Production</label>
            <input type="number" class="form-control" name="males_moved_to_prod" value="{{ log.males_moved_to_prod if log else 0 }}">
          </div>
        </div>
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-header bg-success text-white">Feed</div>
      <div class="card-body">
        <div class="mb-3">
          <label class="form-label">Feed Program</label>
          <select class="form-select" name="feed_program">
            <option value="Full Feed" {{ 'selected' if log and log.feed_program == 'Full Feed' else '' }}>Full Feed</option>
            <option value="Skip-a-day" {{ 'selected' if log and log.feed_program == 'Skip-a-day' else '' }}>Skip-a-day</option>
          </select>
        </div>
        <div class="row">
          <div class="col-6 mb-2">
            <label class="form-label">Male Feed (g/bird)</label>
            <input type="number" step="0.01" class="form-control" name="feed_male_gp_bird" value="{{ log.feed_male_gp_bird if log else 0 }}">
          </div>
          <div class="col-6 mb-2">
            <label class="form-label">Female Feed (g/bird)</label>
            <input type="number" step="0.01" class="form-control" name="feed_female_gp_bird" value="{{ log.feed_female_gp_bird if log else 0 }}">
          </div>
        </div>
        <div class="row">
          <div class="col-6 mb-2">
            <label class="form-label">Feed Cleanup Start</label>
            <input type="time" class="form-control" name="feed_cleanup_start" value="{{ log.feed_cleanup_start if log else '' }}">
          </div>
          <div class="col-6 mb-2">
            <label class="form-label">Feed Cleanup End</label>
            <input type="time" class="form-control" name="feed_cleanup_end" value="{{ log.feed_cleanup_end if log else '' }}">
          </div>
        </div>
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-header bg-info text-white">Water Readings (Enter Whole Numbers)</div>
      <div class="card-body">
        <div class="row">
          <div class="col-4 mb-2">
            <label class="form-label">Reading 1</label>
            <input type="number" class="form-control" name="water_reading_1" value="{{ log.water_reading_1 if log else 0 }}" onchange="calculateWater()">
          </div>
          <div class="col-4 mb-2">
            <label class="form-label">Reading 2</label>
            <input type="number" class="form-control" name="water_reading_2" value="{{ log.water_reading_2 if log else 0 }}" onchange="calculateWater()">
          </div>
          <div class="col-4 mb-2">
            <label class="form-label">Reading 3</label>
            <input type="number" class="form-control" name="water_reading_3" value="{{ log.water_reading_3 if log else 0 }}" onchange="calculateWater()">
          </div>
        </div>
        <div class="mb-3">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" name="flushing" id="flushing" {{ 'checked' if log and log.flushing else '' }}>
                <label class="form-check-label" for="flushing">
                    Flushing Active?
                </label>
            </div>
        </div>
        <small class="text-muted">
          12h Consumption: <span id="water_12h">0</span> Liters
        </small>
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-header bg-warning text-dark">Production</div>
      <div class="card-body">
        <div class="mb-3">
          <label class="form-label">Eggs Collected</label>
          <input type="number" class="form-control" name="eggs_collected" value="{{ log.eggs_collected if log else 0 }}">
        </div>
        <div class="mb-3">
          <label class="form-label">Egg Weight (avg)</label>
          <input type="number" step="0.01" class="form-control" name="egg_weight" value="{{ log.egg_weight if log else 0 }}">
        </div>
        <label class="form-label">Cull Eggs</label>
        <div class="row">
          <div class="col-3"><input type="number" class="form-control form-control-sm" name="cull_eggs_jumbo" placeholder="Jumbo" value="{{ log.cull_eggs_jumbo if log else '' }}"></div>
          <div class="col-3"><input type="number" class="form-control form-control-sm" name="cull_eggs_small" placeholder="Small" value="{{ log.cull_eggs_small if log else '' }}"></div>
          <div class="col-3"><input type="number" class="form-control form-control-sm" name="cull_eggs_abnormal" placeholder="Abnormal" value="{{ log.cull_eggs_abnormal if log else '' }}"></div>
          <div class="col-3"><input type="number" class="form-control form-control-sm" name="cull_eggs_crack" placeholder="Crack" value="{{ log.cull_eggs_crack if log else '' }}"></div>
        </div>
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
        <span>Body Weight & Uniformity</span>
        <div class="form-check form-switch text-light">
           <input class="form-check-input" type="checkbox" id="is_weighing_day" name="is_weighing_day" onchange="togglePartitions()" {{ 'checked' if log and log.is_weighing_day else '' }}>
           <label class="form-check-label" for="is_weighing_day">Weighing Day</label>
        </div>
      </div>
      <div class="card-body">
<<<<<<< HEAD

        {# Assuming we can detect phase. Need to pass 'phase' from backend context or check log.flock.phase #}
        {% set phase = log.flock.phase if log else (active_house_phase if active_house_phase else 'Rearing') %}
        {# Wait, active_house_phase is tricky if not passed. Let's rely on JavaScript or just render both and toggle? #}
        {# Simpler: If editing, we know. If creating, we selected a House. #}
        {# We need JS to toggle based on selected house phase. #}

        <div id="bw-production" class="row">
          <div class="col-6 mb-2">
            <label class="form-label">Male BW (Avg)</label>
            <input type="number" step="0.01" class="form-control" name="body_weight_male" value="{{ log.body_weight_male if log else 0 }}">
          </div>
          <div class="col-6 mb-2">
            <label class="form-label">Female BW (Avg)</label>
            <input type="number" step="0.01" class="form-control" name="body_weight_female" value="{{ log.body_weight_female if log else 0 }}">
=======

        <!-- Standard BW -->
        <div class="row mb-3" id="standard_bw_section">
           <div class="col-6">
             <label class="form-label text-muted small">Std Male BW</label>
             <input type="number" step="0.01" class="form-control form-control-sm" name="standard_bw_male" value="{{ log.standard_bw_male if log else 0 }}">
           </div>
           <div class="col-6">
             <label class="form-label text-muted small">Std Female BW</label>
             <input type="number" step="0.01" class="form-control form-control-sm" name="standard_bw_female" value="{{ log.standard_bw_female if log else 0 }}">
           </div>
        </div>

        <!-- Partitions Section (Hidden unless Weighing Day & Rearing) -->
        <div id="partitions_section" style="display:none;">
            <h6 class="text-primary">Male Partitions (2)</h6>
            <div class="row mb-2">
                <div class="col-3"><input type="number" step="0.01" class="form-control form-control-sm" name="bw_male_p1" placeholder="M BW P1" value="{{ log.bw_male_p1 if log else 0 }}" onchange="calcAvg()"></div>
                <div class="col-3"><input type="number" step="0.01" class="form-control form-control-sm" name="unif_male_p1" placeholder="M Unif P1" value="{{ log.unif_male_p1 if log else 0 }}" onchange="calcAvg()"></div>
                <div class="col-3"><input type="number" step="0.01" class="form-control form-control-sm" name="bw_male_p2" placeholder="M BW P2" value="{{ log.bw_male_p2 if log else 0 }}" onchange="calcAvg()"></div>
                <div class="col-3"><input type="number" step="0.01" class="form-control form-control-sm" name="unif_male_p2" placeholder="M Unif P2" value="{{ log.unif_male_p2 if log else 0 }}" onchange="calcAvg()"></div>
            </div>

            <h6 class="text-danger">Female Partitions (4)</h6>
            <div class="row mb-2">
                <div class="col-3"><input type="number" step="0.01" class="form-control form-control-sm" name="bw_female_p1" placeholder="F BW P1" value="{{ log.bw_female_p1 if log else 0 }}" onchange="calcAvg()"></div>
                <div class="col-3"><input type="number" step="0.01" class="form-control form-control-sm" name="unif_female_p1" placeholder="F Unif P1" value="{{ log.unif_female_p1 if log else 0 }}" onchange="calcAvg()"></div>
                <div class="col-3"><input type="number" step="0.01" class="form-control form-control-sm" name="bw_female_p2" placeholder="F BW P2" value="{{ log.bw_female_p2 if log else 0 }}" onchange="calcAvg()"></div>
                <div class="col-3"><input type="number" step="0.01" class="form-control form-control-sm" name="unif_female_p2" placeholder="F Unif P2" value="{{ log.unif_female_p2 if log else 0 }}" onchange="calcAvg()"></div>
            </div>
            <div class="row mb-2">
                <div class="col-3"><input type="number" step="0.01" class="form-control form-control-sm" name="bw_female_p3" placeholder="F BW P3" value="{{ log.bw_female_p3 if log else 0 }}" onchange="calcAvg()"></div>
                <div class="col-3"><input type="number" step="0.01" class="form-control form-control-sm" name="unif_female_p3" placeholder="F Unif P3" value="{{ log.unif_female_p3 if log else 0 }}" onchange="calcAvg()"></div>
                <div class="col-3"><input type="number" step="0.01" class="form-control form-control-sm" name="bw_female_p4" placeholder="F BW P4" value="{{ log.bw_female_p4 if log else 0 }}" onchange="calcAvg()"></div>
                <div class="col-3"><input type="number" step="0.01" class="form-control form-control-sm" name="unif_female_p4" placeholder="F Unif P4" value="{{ log.unif_female_p4 if log else 0 }}" onchange="calcAvg()"></div>
            </div>
            <hr>
        </div>

        <div class="row" id="average_section">
          <div class="col-6 mb-2">
            <label class="form-label">Avg Male BW</label>
            <input type="number" step="0.01" class="form-control" name="body_weight_male" id="body_weight_male" value="{{ log.body_weight_male if log else 0 }}">
          </div>
          <div class="col-6 mb-2">
            <label class="form-label">Avg Female BW</label>
            <input type="number" step="0.01" class="form-control" name="body_weight_female" id="body_weight_female" value="{{ log.body_weight_female if log else 0 }}">
>>>>>>> origin/main
          </div>
          <div class="col-6 mb-2">
            <label class="form-label">Avg Male Unif %</label>
            <input type="number" step="0.01" class="form-control" name="uniformity_male" id="uniformity_male" value="{{ log.uniformity_male if log else 0 }}">
          </div>
          <div class="col-6 mb-2">
            <label class="form-label">Avg Female Unif %</label>
            <input type="number" step="0.01" class="form-control" name="uniformity_female" id="uniformity_female" value="{{ log.uniformity_female if log else 0 }}">
          </div>
        </div>

        <div id="bw-rearing" class="mt-3" style="display: none;">
            <hr>
            <h6>Rearing Partitions (Auto-calculates Avg)</h6>
            <div class="row">
                <div class="col-md-6">
                    <strong>Female Partitions</strong>
                    {% for i in range(1, 5) %}
                    <div class="row mb-1">
                        <div class="col-2"><label class="col-form-label btn-sm">F{{i}}</label></div>
                        <div class="col-5"><input type="number" step="0.01" class="form-control form-control-sm" name="bw_F{{i}}" placeholder="BW" value="{{ get_partition_val(log, 'F'~i, 'bw') }}"></div>
                        <div class="col-5"><input type="number" step="0.01" class="form-control form-control-sm" name="uni_F{{i}}" placeholder="Uni%" value="{{ get_partition_val(log, 'F'~i, 'uni') }}"></div>
                    </div>
                    {% endfor %}
                </div>
                <div class="col-md-6">
                    <strong>Male Partitions</strong>
                    {% for i in range(1, 3) %}
                    <div class="row mb-1">
                        <div class="col-2"><label class="col-form-label btn-sm">M{{i}}</label></div>
                        <div class="col-5"><input type="number" step="0.01" class="form-control form-control-sm" name="bw_M{{i}}" placeholder="BW" value="{{ get_partition_val(log, 'M'~i, 'bw') }}"></div>
                        <div class="col-5"><input type="number" step="0.01" class="form-control form-control-sm" name="uni_M{{i}}" placeholder="Uni%" value="{{ get_partition_val(log, 'M'~i, 'uni') }}"></div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-header bg-dark text-white">Other & Clinical</div>
      <div class="card-body">
        <div class="row mb-3">
          <div class="col-6">
            <label class="form-label">Light On</label>
            <input type="time" class="form-control" name="light_on_time" value="{{ log.light_on_time if log else '' }}">
          </div>
          <div class="col-6">
            <label class="form-label">Light Off</label>
            <input type="time" class="form-control" name="light_off_time" value="{{ log.light_off_time if log else '' }}">
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label">Clinical Notes</label>
          <textarea class="form-control" name="clinical_notes" rows="3">{{ log.clinical_notes if log else '' }}</textarea>
        </div>
        <div class="mb-3">
          <label class="form-label">Photo Upload (Post-Mortem)</label>
          <input type="file" class="form-control" name="photo">
          {% if log and log.photo_path %}
            <small class="text-muted">Current photo: {{ log.photo_path }}</small>
          {% endif %}
        </div>
      </div>
    </div>

    <button type="submit" class="btn btn-primary w-100 mb-5">{{ 'Update Log' if log else 'Submit Log' }}</button>
  </form>
  
  <script>
    {% if not log %}
    // Set default date to today only for new logs
    document.getElementById('date').valueAsDate = new Date();
    {% endif %}

    function calculateWater() {
        // Get values (integers)
        let r1 = parseFloat(document.getElementsByName('water_reading_1')[0].value) || 0;
        let r3 = parseFloat(document.getElementsByName('water_reading_3')[0].value) || 0;
        
        // Convert to real values (divide by 100)
        let r1_real = r1 / 100;
        let r3_real = r3 / 100;
        
        // 12h Consumption = (R3 - R1) * 1000 Liters
        // Wait, unit: meter cubic. 1 m3 = 1000 L.
        // Formula: (R3 - R1) * 1000.
        
        let consumption12h = (r3_real - r1_real) * 1000;
        document.getElementById('water_12h').innerText = consumption12h.toFixed(2);
    }

<<<<<<< HEAD
    // Phase Toggle Logic
    const flockPhases = {{ flock_phases_json | default('{}') | safe }};

    function updatePhaseVisibility() {
        // If editing existing log, we rely on backend logic passed or check hidden input if added.
        // But simplified: check active house selection.
        const houseSelect = document.getElementById('house_id');
        let phase = 'Rearing'; // default

        if (houseSelect) {
            // New Log mode
            const houseId = houseSelect.value;
            // We need flock phases map. Let's pass it from backend.
            phase = flockPhases[houseId] || 'Rearing';
        } else {
            // Edit mode: we injected phase variable or just rely on server side render?
            // Actually, we need to toggle display NOW.
            // Let's check a data attribute or hidden field.
            // For now, let's assume if the Rearing block has values, show it.
            // Or better: Pass flock.phase to template script.
            {% if log %}
            phase = '{{ log.flock.phase }}';
            {% endif %}
        }

        const prodDiv = document.getElementById('bw-production');
        const rearingDiv = document.getElementById('bw-rearing');

        if (phase === 'Rearing') {
            prodDiv.style.display = 'none'; // Or 'flex' if we want to show the calculated avg too?
            // User said "only have one box... when start production". Implies in Rearing we have the 4 boxes.
            // Let's show Rearing Partitions AND maybe the result (avg) as readonly?
            // User: "create a new format... where it have 4 boxes... When start production, it will only have on box"
            // So toggle visibility.
            rearingDiv.style.display = 'block';
            prodDiv.style.display = 'none';
        } else {
            rearingDiv.style.display = 'none';
            prodDiv.style.display = 'flex';
        }
    }

    // Run on load and change
    document.addEventListener('DOMContentLoaded', updatePhaseVisibility);
    if(document.getElementById('house_id')) {
        document.getElementById('house_id').addEventListener('change', updatePhaseVisibility);
    }
=======
    // Phase & Partition Logic
    function updatePhase() {
        let houseSelect = document.getElementById('house_id');
        let phase = 'Rearing';
        if (houseSelect) {
            let option = houseSelect.options[houseSelect.selectedIndex];
            phase = option.getAttribute('data-phase') || 'Rearing';
        } else {
            // Edit mode
            phase = document.getElementById('phase_val').value;
        }

        let partitionsDiv = document.getElementById('partitions_section');
        let avgDiv = document.getElementById('average_section');
        let weighingCheck = document.getElementById('is_weighing_day');

        // Logic:
        // Production -> Always Show Average (Editable). Hide Partitions. Hide Weighing Checkbox?
        // Rearing ->
        //    Weighing Checkbox visible.
        //    If Checked -> Show Partitions, Average is ReadOnly.
        //    If Unchecked -> Hide Partitions, Hide Average (or Disabled 0).

        // Actually user said: "During production phase, hide partition; only average input."
        // And "hide bodyweight column if there is no weighing that day" (Rearing).

        if (phase === 'Production') {
            partitionsDiv.style.display = 'none';
            avgDiv.style.display = 'flex'; // Show row
            setAvgReadonly(false);
            // Hide Checkbox container? Or just uncheck it?
            // weighingCheck.closest('.form-switch').style.display = 'none';
            // User didn't strictly say hide checkbox in production, but implied partitions irrelevant.
        } else {
            // Rearing
            // weighingCheck.closest('.form-switch').style.display = 'block';
            togglePartitions();
        }
    }

    function togglePartitions() {
        let isWeighing = document.getElementById('is_weighing_day').checked;
        let partitionsDiv = document.getElementById('partitions_section');
        let avgDiv = document.getElementById('average_section');

        // Double check phase
        let houseSelect = document.getElementById('house_id');
        let phase = 'Rearing';
        if (houseSelect) {
             phase = houseSelect.options[houseSelect.selectedIndex].getAttribute('data-phase');
        } else {
             phase = document.getElementById('phase_val').value;
        }

        if (phase === 'Production') {
            partitionsDiv.style.display = 'none';
            avgDiv.style.display = 'flex';
            setAvgReadonly(false);
            return;
        }

        if (isWeighing) {
            partitionsDiv.style.display = 'block';
            avgDiv.style.display = 'flex';
            setAvgReadonly(true);
            calcAvg();
        } else {
            partitionsDiv.style.display = 'none';
            // "hide bodyweight column if there is no weighing that day"
            avgDiv.style.display = 'none';
            // Optional: Clear values?
        }
    }

    function setAvgReadonly(readonly) {
        let ids = ['body_weight_male', 'body_weight_female', 'uniformity_male', 'uniformity_female'];
        ids.forEach(id => {
            let el = document.getElementById(id);
            if(readonly) {
                el.setAttribute('readonly', true);
                el.classList.add('bg-light');
            } else {
                el.removeAttribute('readonly');
                el.classList.remove('bg-light');
            }
        });
    }

    function calcAvg() {
        // Only run if partitions visible
        if (document.getElementById('partitions_section').style.display === 'none') return;

        // Male
        let m_p1 = parseFloat(document.getElementsByName('bw_male_p1')[0].value) || 0;
        let m_p2 = parseFloat(document.getElementsByName('bw_male_p2')[0].value) || 0;
        let m_cnt = 0, m_sum = 0;
        if (m_p1 > 0) { m_sum += m_p1; m_cnt++; }
        if (m_p2 > 0) { m_sum += m_p2; m_cnt++; }
        document.getElementById('body_weight_male').value = (m_cnt > 0 ? (m_sum / m_cnt) : 0).toFixed(2);

        let mu_p1 = parseFloat(document.getElementsByName('unif_male_p1')[0].value) || 0;
        let mu_p2 = parseFloat(document.getElementsByName('unif_male_p2')[0].value) || 0;
        let mu_sum = 0;
        if (mu_p1 > 0) mu_sum += mu_p1;
        if (mu_p2 > 0) mu_sum += mu_p2;
        // Simple avg of unif?
        document.getElementById('uniformity_male').value = (m_cnt > 0 ? (mu_sum / m_cnt) : 0).toFixed(2);

        // Female
        let f_p1 = parseFloat(document.getElementsByName('bw_female_p1')[0].value) || 0;
        let f_p2 = parseFloat(document.getElementsByName('bw_female_p2')[0].value) || 0;
        let f_p3 = parseFloat(document.getElementsByName('bw_female_p3')[0].value) || 0;
        let f_p4 = parseFloat(document.getElementsByName('bw_female_p4')[0].value) || 0;

        let f_cnt = 0, f_sum = 0;
        if (f_p1 > 0) { f_sum += f_p1; f_cnt++; }
        if (f_p2 > 0) { f_sum += f_p2; f_cnt++; }
        if (f_p3 > 0) { f_sum += f_p3; f_cnt++; }
        if (f_p4 > 0) { f_sum += f_p4; f_cnt++; }
        document.getElementById('body_weight_female').value = (f_cnt > 0 ? (f_sum / f_cnt) : 0).toFixed(2);

        let fu_p1 = parseFloat(document.getElementsByName('unif_female_p1')[0].value) || 0;
        let fu_p2 = parseFloat(document.getElementsByName('unif_female_p2')[0].value) || 0;
        let fu_p3 = parseFloat(document.getElementsByName('unif_female_p3')[0].value) || 0;
        let fu_p4 = parseFloat(document.getElementsByName('unif_female_p4')[0].value) || 0;
        let fu_sum = 0;
        if (fu_p1 > 0) fu_sum += fu_p1;
        if (fu_p2 > 0) fu_sum += fu_p2;
        if (fu_p3 > 0) fu_sum += fu_p3;
        if (fu_p4 > 0) fu_sum += fu_p4;
        document.getElementById('uniformity_female').value = (f_cnt > 0 ? (fu_sum / f_cnt) : 0).toFixed(2);
    }

    // Initialize
    window.onload = function() {
        updatePhase();
    };
>>>>>>> origin/main
  </script>
{% endif %}
{% endblock %}
