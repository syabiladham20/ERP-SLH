{% extends 'base.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2>Flock Details: {{ flock.house.name }}</h2>
  <div class="dropdown">
    <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton1" data-bs-toggle="dropdown" aria-expanded="false">
      Switch House
    </button>
    <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
      {% for f in active_flocks %}
      <li><a class="dropdown-item" href="{{ url_for('view_flock', id=f.id) }}">{{ f.house.name }}</a></li>
      {% endfor %}
    </ul>
  </div>
</div>

<!-- Overview Card -->
<div class="card mb-4">
  <div class="card-header sticky-header">
    Overview
  </div>
  <div class="card-body">
    <div class="row">
      <div class="col-md-3"><strong>House:</strong> {{ flock.house.name }}</div>
      <div class="col-md-3"><strong>Status:</strong> {{ flock.status }}</div>
      <div class="col-md-3"><strong>Phase:</strong> {{ flock.phase }}</div>
      <div class="col-md-3"><strong>Intake Date:</strong> {{ flock.intake_date | date_fmt }}</div>
    </div>
    <div class="row mt-2">
      <div class="col-md-3"><strong>Intake:</strong> {{ flock.intake_male }} M / {{ flock.intake_female }} F</div>
      <div class="col-md-3"><strong>DOA:</strong> {{ flock.doa_male }} M / {{ flock.doa_female }} F</div>
      <div class="col-md-3 border-start">
          <strong>Current Prod:</strong> {{ current_stats.male_prod }} M / {{ current_stats.female_prod }} F
          <br>
          <small class="text-muted">Male Ratio: {{ "%.2f"|format(current_stats.male_ratio) }}%</small>
      </div>
      <div class="col-md-3">
          <strong>Current Hosp:</strong> {{ current_stats.male_hosp }} M / {{ current_stats.female_hosp }} F
      </div>
    </div>
  </div>
  <div class="card-footer">
    {% for item in get_ui_elements('flock_detail') %}
        {% if item.key == 'detail_kpi' %}
            <a href="{{ url_for('flock_dashboard', id=flock.id) }}" class="btn btn-sm btn-success me-2">{{ item.label }}</a>
        {% elif item.key == 'detail_custom' %}
            <a href="{{ url_for('flock_custom_dashboard', id=flock.id) }}" class="btn btn-sm btn-warning me-2">{{ item.label }}</a>
        {% elif item.key == 'detail_charts' %}
            <a href="{{ url_for('flock_charts', id=flock.id) }}" class="btn btn-sm btn-primary me-2">{{ item.label }}</a>
        {% elif item.key == 'detail_hatch' %}
            <a href="{{ url_for('flock_hatchability', id=flock.id) }}" class="btn btn-sm btn-info text-white me-2">{{ item.label }}</a>
        {% elif item.key == 'detail_health' %}
            <a href="{{ url_for('health_log', flock_id=flock.id) }}" class="btn btn-sm btn-danger">{{ item.label }}</a>
        {% endif %}
    {% endfor %}
  </div>
</div>

<!-- Navigation Tabs -->
<ul class="nav nav-tabs mb-3" id="flockTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="daily-tab" data-bs-toggle="tab" data-bs-target="#daily" type="button" role="tab" aria-controls="daily" aria-selected="true">Daily Logs</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="weekly-tab" data-bs-toggle="tab" data-bs-target="#weekly" type="button" role="tab" aria-controls="weekly" aria-selected="false">Weekly Summary</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="charts-tab" data-bs-toggle="tab" data-bs-target="#charts" type="button" role="tab" aria-controls="charts" aria-selected="false">Performance Charts</button>
  </li>
</ul>

<!-- Tab Content -->
<div class="tab-content" id="flockTabsContent">

  <!-- Daily Logs Tab (Pane 1) -->
  <div class="tab-pane fade show active" id="daily" role="tabpanel" aria-labelledby="daily-tab">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h3>Daily Logs</h3>
    </div>
    <div class="table-responsive table-responsive-sticky">
      <table class="table table-bordered table-sm text-center align-middle" style="font-size: 0.8rem;">
        <thead class="sticky-table-header table-light">
          <tr>
            <th rowspan="2" class="align-middle">Date</th>
            <th rowspan="2" class="align-middle">House</th>
            <th rowspan="2" class="align-middle">Age</th>
            <th colspan="2" class="bg-light">Stock</th>
            <th colspan="2" class="bg-danger bg-opacity-10">Mortality</th>
            <th colspan="2" class="bg-warning bg-opacity-10">Culls</th>
            <th rowspan="2" class="align-middle">Feed<br>(Kg)</th>
            <th colspan="2" class="bg-success bg-opacity-10">Feed/Bird<br>(g)</th>
            <th rowspan="2" class="align-middle">Water<br>(ml/bird)</th>
            <th rowspan="2" class="align-middle">Medication</th>
            <th colspan="3" class="bg-info bg-opacity-10">Production</th>
            <th colspan="2">Jumbo</th>
            <th colspan="2">Small</th>
            <th colspan="2">Crack</th>
            <th colspan="2">Abnormal</th>
            <th colspan="2" class="bg-primary bg-opacity-10">Hatching</th>
            <th colspan="2" class="bg-secondary bg-opacity-10">Reject</th>
            <th rowspan="2" class="align-middle">Light<br>(Hr)</th>
            <th rowspan="2" class="align-middle">Actions</th>
          </tr>
          <tr>
            <th class="bg-light">M</th>
            <th class="bg-light">F</th>
            <th class="bg-danger bg-opacity-10">M</th>
            <th class="bg-danger bg-opacity-10">F</th>
            <th class="bg-warning bg-opacity-10">M</th>
            <th class="bg-warning bg-opacity-10">F</th>
            <th class="bg-success bg-opacity-10">M</th>
            <th class="bg-success bg-opacity-10">F</th>
            <th class="bg-info bg-opacity-10">%</th>
            <th class="bg-info bg-opacity-10">Wt(g)</th>
            <th class="bg-info bg-opacity-10">Qty</th>
            <th>#</th>
            <th>%</th>
            <th>#</th>
            <th>%</th>
            <th>#</th>
            <th>%</th>
            <th>#</th>
            <th>%</th>
            <th class="bg-primary bg-opacity-10">#</th>
            <th class="bg-primary bg-opacity-10">%</th>
            <th class="bg-secondary bg-opacity-10">#</th>
            <th class="bg-secondary bg-opacity-10">%</th>
          </tr>
        </thead>
        <tbody>
          {% for item in logs %}
          <tr>
            <td class="text-nowrap fw-bold">{{ item.log.date | date_fmt }}</td>
            <td>{{ flock.house.name }}</td>
            <td>W{{ item.log.age_week_day.split('.')[0] }}</td>

            <td class="fw-bold">{{ item.stock_male }}</td>
            <td class="fw-bold">{{ item.stock_female }}</td>

            <td class="{{ 'text-danger fw-bold' if item.log.mortality_male > 0 else 'text-muted' }}">{{ item.log.mortality_male }}</td>
            <td class="{{ 'text-danger fw-bold' if item.log.mortality_female > 0 else 'text-muted' }}">{{ item.log.mortality_female }}</td>

            <td class="{{ 'text-warning fw-bold' if item.log.culls_male > 0 else 'text-muted' }}">{{ item.log.culls_male }}</td>
            <td class="{{ 'text-warning fw-bold' if item.log.culls_female > 0 else 'text-muted' }}">{{ item.log.culls_female }}</td>

            <td class="fw-bold">{{ "%.1f"|format(item.total_feed) }}</td>

            <td>{{ item.log.feed_male_gp_bird }}g</td>
            <td>{{ item.log.feed_female_gp_bird }}g</td>

            {% set total_birds = item.stock_male + item.stock_female %}
            {% set water_per_bird = (item.log.water_intake_calculated * 1000) / total_birds if total_birds > 0 else 0 %}
            <td>{{ "%.0f"|format(water_per_bird) }}</td>

            <td class="text-start small" style="max-width: 120px; white-space: normal; line-height: 1.1;">
                {% if item.medications %}
                    <span class="badge bg-info text-dark">{{ item.medications }}</span>
                {% else %}
                    -
                {% endif %}
            </td>

            <td class="{{ 'bg-success text-white' if item.egg_prod_pct >= 85 else '' }} fw-bold">
                {{ "%.2f"|format(item.egg_prod_pct) }}%
            </td>
            <td>{{ item.log.egg_weight }}</td>
            <td class="fw-bold">{{ item.log.eggs_collected }}</td>

            <!-- Cull Details -->
            <td class="small">{{ item.egg_data.jumbo }}</td>
            <td class="text-muted small" style="font-size: 0.75rem;">{{ "%.2f"|format(item.egg_data.jumbo_pct) }}%</td>

            <td class="small">{{ item.egg_data.small }}</td>
            <td class="text-muted small" style="font-size: 0.75rem;">{{ "%.2f"|format(item.egg_data.small_pct) }}%</td>

            <td class="small">{{ item.egg_data.crack }}</td>
            <td class="text-muted small" style="font-size: 0.75rem;">{{ "%.2f"|format(item.egg_data.crack_pct) }}%</td>

            <td class="small">{{ item.egg_data.abnormal }}</td>
            <td class="text-muted small" style="font-size: 0.75rem;">{{ "%.2f"|format(item.egg_data.abnormal_pct) }}%</td>

            <td class="fw-bold text-primary">{{ item.egg_data.hatching }}</td>
            <td class="fw-bold text-primary">{{ "%.2f"|format(item.egg_data.hatching_pct) }}%</td>

            <td class="fw-bold text-danger">{{ item.egg_data.total_culls }}</td>
            <td class="fw-bold text-danger">{{ "%.2f"|format(item.egg_data.total_culls_pct) }}%</td>

            <td>{{ item.lighting_hours }} hour</td>

            <td>
              <a href="{{ url_for('edit_daily_log', id=item.log.id) }}" class="btn btn-sm btn-outline-primary py-0" style="font-size: 0.75rem;">Edit</a>
              {% if is_admin %}
              <form action="{{ url_for('delete_daily_log', id=item.log.id) }}" method="POST" class="d-inline" onsubmit="return confirm('Delete this daily log? Metrics will be removed.');">
                  <button class="btn btn-sm btn-outline-danger py-0" style="font-size: 0.75rem;">Del</button>
              </form>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Weekly Summary Tab (Pane 2) -->
  <div class="tab-pane fade" id="weekly" role="tabpanel" aria-labelledby="weekly-tab">
    {% if weekly_data %}
    <h3>Weekly Summary</h3>
    <div class="table-responsive table-responsive-sticky mb-4">
      <table class="table table-bordered table-sm">
        <thead class="table-light sticky-table-header">
          <tr>
            <th>Week</th>
            <th>Mortality (M/F)</th>
            <th>Mortality % (M/F)</th>
            <th>Culls (M/F)</th>
            <th>Culls % (M/F)</th>
            <th>Eggs</th>
            <th>Egg Prod %</th>
            <th>Hatching Eggs</th>
            <th>Hatching Egg %</th>
            <th>Avg BW (M/F)</th>
          </tr>
        </thead>
        <tbody>
          {% for w in weekly_data %}
          <tr>
            <td>{{ w.week }}</td>
            <td>{{ w.mortality_male }} / {{ w.mortality_female }}</td>
            <td>{{ "%.2f"|format(w.mort_pct_m) }} / {{ "%.2f"|format(w.mort_pct_f) }}</td>
            <td>{{ w.culls_male }} / {{ w.culls_female }}</td>
            <td>{{ "%.2f"|format(w.cull_pct_m) }} / {{ "%.2f"|format(w.cull_pct_f) }}</td>
            <td>{{ w.eggs }}</td>
            <td>{{ "%.2f"|format(w.egg_prod_pct) }}</td>
            <td>{{ w.hatch_eggs_sum }}</td>
            <td>{{ "%.2f"|format(w.hatching_egg_pct) }}</td>
            <td>{{ w.avg_bw_male }} / {{ w.avg_bw_female }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="text-muted p-3">No weekly data available.</p>
    {% endif %}
  </div>

  <!-- Charts Tab (Pane 3) -->
  <div class="tab-pane fade" id="charts" role="tabpanel" aria-labelledby="charts-tab">
<!-- General Performance Chart -->
<div class="card mb-4 mt-3">
  <div class="card-header sticky-header d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2">
    <span class="fw-bold mb-2 mb-md-0">General Performance</span>
    <div class="d-flex flex-wrap gap-2">
        <div class="btn-group btn-group-sm" role="group">
             <input type="radio" class="btn-check" name="chartMode" id="modeDaily" autocomplete="off" checked onchange="switchMode('daily')">
             <label class="btn btn-outline-secondary" for="modeDaily">Daily</label>

             <input type="radio" class="btn-check" name="chartMode" id="modeWeekly" autocomplete="off" onchange="switchMode('weekly')">
             <label class="btn btn-outline-secondary" for="modeWeekly">Weekly</label>
        </div>
        <!-- Filter Controls -->
        <div class="btn-group btn-group-sm" role="group" id="generalFilterControls">
            <button class="btn btn-outline-secondary" onclick="applyDateFilter('general', 'default')">Default (30d/10w)</button>
            <button class="btn btn-outline-secondary" onclick="applyDateFilter('general', 'all')">Show All</button>
        </div>
    </div>
  </div>
  <div class="card-body">
    <div style="position: relative; height: 60vh; min-height: 500px; width: 100%;">
      <canvas id="generalChart"></canvas>
    </div>
  </div>
</div>

<!-- Male Chart -->
<div class="card mb-4">
  <div class="card-header sticky-header d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2">
    <span class="fw-bold mb-2 mb-md-0">Male Statistics (BW & Uniformity)</span>
    <div>
        <div class="btn-group btn-group-sm" role="group">
             <button class="btn btn-outline-secondary" onclick="applyDateFilter('male', 'default')">Last 10 Weeks</button>
             <button class="btn btn-outline-secondary" onclick="applyDateFilter('male', 'all')">Show All</button>
        </div>
    </div>
  </div>
  <div class="card-body">
    <div style="position: relative; height: 50vh; min-height: 400px; width: 100%;">
      <canvas id="maleChart"></canvas>
    </div>
  </div>
</div>

<!-- Female Chart -->
<div class="card mb-4">
  <div class="card-header sticky-header d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2">
      <span class="fw-bold mb-2 mb-md-0">Female Statistics (BW & Uniformity)</span>
      <div class="btn-group btn-group-sm" role="group">
             <button class="btn btn-outline-secondary" onclick="applyDateFilter('female', 'default')">Last 10 Weeks</button>
             <button class="btn btn-outline-secondary" onclick="applyDateFilter('female', 'all')">Show All</button>
      </div>
  </div>
  <div class="card-body">
    <div style="position: relative; height: 50vh; min-height: 400px; width: 100%;">
      <canvas id="femaleChart"></canvas>
    </div>
  </div>
</div>
    </div>

</div>

<!-- Note Modal -->
<div class="modal fade" id="noteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="noteModalTitle">Clinical Note</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <div id="noteModalPhoto" class="mb-3" style="display: none;">
          <img src="" class="img-fluid rounded border" alt="Clinical Photo">
        </div>
        <p id="noteModalText" class="lead"></p>
        <p id="noteModalDate" class="text-muted small"></p>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
<script>

  // Register plugin
  Chart.register(ChartDataLabels);

  const chartDataDaily = {{ chart_data | tojson }};
  const chartDataWeekly = {{ chart_data_weekly | tojson }};
  const globalStd = {{ global_std.std_mortality_daily if global_std else 0.05 }};
  const globalStdWeekly = {{ global_std.std_mortality_weekly if global_std else 0.3 }};

  let maleChart, femaleChart, generalChart;
  let currentMode = 'daily';

  // Helper to slice data
  function filterData(dataObj, count) {
      if (count === 'all' || count >= dataObj.dates.length) return dataObj;
      const start = dataObj.dates.length - count;
      const newObj = {};
      for (let key in dataObj) {
          if (Array.isArray(dataObj[key])) {
              newObj[key] = dataObj[key].slice(start);
          } else {
              newObj[key] = dataObj[key];
          }
      }
      return newObj;
  }

  function renderCharts(mode) {
      currentMode = mode;
      const fullData = mode === 'weekly' ? chartDataWeekly : chartDataDaily;

      // Defaults: 30 for Daily, 10 for Weekly
      const defaultGeneralCount = mode === 'daily' ? 30 : 10;
      const generalData = filterData(fullData, window.generalFilterState || defaultGeneralCount);

      // Body Weight Charts (Fixed Weekly)
      const bwData = filterData(chartDataWeekly, window.bwFilterState || 10);


      // Destroy existing
      if (maleChart) maleChart.destroy();
      if (femaleChart) femaleChart.destroy();
      if (generalChart) generalChart.destroy();

      // --- Common Options ---
      const commonOptions = {
          responsive: true,
          maintainAspectRatio: false,
          spanGaps: true,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          plugins: {
              legend: {
                  position: 'bottom',
                  labels: {
                      usePointStyle: true,
                      padding: 20
                  }
              },
              zoom: {
                zoom: {
                  wheel: { enabled: true },
                  pinch: { enabled: true },
                  mode: 'x',
                },
                pan: {
                  enabled: true,
                  mode: 'x',
                }
              },
              datalabels: {
                  align: 'top',
                  anchor: 'end',
                  formatter: function(value, context) {
                      if (!value) return '';
                      if (context.dataset.yAxisID === 'y1' || context.dataset.label.includes('%')) {
                          return parseFloat(value).toFixed(2) + '%';
                      }
                      return value;
                  },
                  font: { weight: 'bold', size: 10 },
                  color: '#333'
              },
              tooltip: {
                  callbacks: {
                      label: function(context) {
                          let label = context.dataset.label || '';
                          if (label) {
                              label += ': ';
                          }
                          if (context.dataset.label === 'Clinical Notes') {
                              return context.raw.note.substring(0, 50) + (context.raw.note.length > 50 ? '...' : '');
                          }
                          if (context.parsed.y !== null) {
                              if (context.dataset.yAxisID === 'y1' || context.dataset.label.includes('%')) {
                                  label += parseFloat(context.parsed.y).toFixed(2) + '%';
                              } else {
                                  label += context.parsed.y;
                              }
                          }
                          return label;
                      },
                      afterBody: function(context) {
                          const noteItem = context.find(i => i.dataset.label === 'Clinical Notes');
                          if (noteItem && noteItem.raw && noteItem.raw.note) {
                              return '\nNote: ' + noteItem.raw.note;
                          }
                      }
                  }
              }
          }
      };

      // --- Male Chart (Weekly Fixed) ---
      const maleDatasets = [];
      const colorsM = ['#36A2EB', '#0056b3', '#4bc0c0', '#198754', '#0dcaf0', '#6610f2', '#6f42c1', '#d63384'];

      // Avg BW
      if (bwData.avg_bw_male && bwData.avg_bw_male.some(v => v !== null)) {
           maleDatasets.push({
                label: 'Avg BW Male',
                data: bwData.avg_bw_male,
                borderColor: '#000',
                backgroundColor: '#000',
                borderWidth: 2,
                tension: 0.1,
                yAxisID: 'y'
           });
      }

      // Dynamic Partitions 1-8
      for (let i = 1; i <= 8; i++) {
          let key = 'bw_M' + i;
          if (bwData[key] && bwData[key].some(val => val !== null)) {
              maleDatasets.push({
                label: 'BW M' + i,
                data: bwData[key],
                borderColor: colorsM[i-1] || '#333',
                backgroundColor: colorsM[i-1] || '#333',
                tension: 0.1,
                yAxisID: 'y'
              });
          }
      }

      maleDatasets.push({
          label: 'Std BW',
          data: bwData.bw_male_std,
          borderColor: '#000000',
          borderDash: [5, 5],
          pointRadius: 0,
          borderWidth: 1,
          yAxisID: 'y',
          datalabels: { display: false }
      });

      maleDatasets.push({
          label: 'Uniformity %',
          data: bwData.unif_male,
          borderColor: '#FFCE56',
          borderDash: [2, 2],
          pointStyle: 'rectRot',
          yAxisID: 'y1'
      });

      maleChart = new Chart(document.getElementById('maleChart').getContext('2d'), {
        type: 'line',
        data: {
          labels: bwData.dates,
          datasets: maleDatasets
        },
        options: {
            ...commonOptions,
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: { display: true, text: 'Body Weight (g)' }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: { display: true, text: 'Uniformity' },
                    min: 0,
                    max: 100,
                    grid: { drawOnChartArea: false },
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            }
        }
      });

      // --- Female Chart (Weekly Fixed) ---
      const femaleDatasets = [];
      const colorsF = ['#FF6384', '#FF9F40', '#FFCD56', '#4BC0C0', '#9966FF', '#C9CBCF', '#fd7e14', '#20c997'];

      // Avg BW
      if (bwData.avg_bw_female && bwData.avg_bw_female.some(v => v !== null)) {
           femaleDatasets.push({
                label: 'Avg BW Female',
                data: bwData.avg_bw_female,
                borderColor: '#000',
                backgroundColor: '#000',
                borderWidth: 2,
                tension: 0.1,
                yAxisID: 'y'
           });
      }

      for (let i = 1; i <= 8; i++) {
          let key = 'bw_F' + i;
          if (bwData[key] && bwData[key].some(val => val !== null)) {
              femaleDatasets.push({
                label: 'BW F' + i,
                data: bwData[key],
                borderColor: colorsF[i-1] || '#333',
                backgroundColor: colorsF[i-1] || '#333',
                yAxisID: 'y'
              });
          }
      }

      femaleDatasets.push({
          label: 'Std BW',
          data: bwData.bw_female_std,
          borderColor: '#000000',
          borderDash: [5, 5],
          pointRadius: 0,
          borderWidth: 1,
          yAxisID: 'y',
          datalabels: { display: false }
      });

      femaleDatasets.push({
          label: 'Uniformity %',
          data: bwData.unif_female,
          borderColor: '#9966FF',
          borderDash: [2, 2],
          pointStyle: 'rectRot',
          yAxisID: 'y1'
      });

      femaleChart = new Chart(document.getElementById('femaleChart').getContext('2d'), {
        type: 'line',
        data: {
          labels: bwData.dates,
          datasets: femaleDatasets
        },
        options: {
            ...commonOptions,
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: { display: true, text: 'Body Weight (g)' }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: { display: true, text: 'Uniformity' },
                    min: 0,
                    max: 100,
                    grid: { drawOnChartArea: false },
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            }
        }
      });

      // --- General Chart (Dynamic Mode) ---

      const stdVal = mode === 'daily' ? globalStd : globalStdWeekly;

      // Determine keys based on mode
      const mortMKey = mode === 'daily' ? 'mortality_daily_male' : 'mortality_weekly_male';
      const mortFKey = mode === 'daily' ? 'mortality_daily_female' : 'mortality_weekly_female';
      const cullMKey = mode === 'daily' ? 'culls_daily_male' : 'culls_weekly_male';
      const cullFKey = mode === 'daily' ? 'culls_daily_female' : 'culls_weekly_female';

      const baselineData = new Array(generalData.dates.length).fill(stdVal);

      // Prepare Notes Dataset
      const notesPoints = generalData.dates.map((d, i) => {
          const n = generalData.notes ? generalData.notes[i] : null;
          if (n) {
              // Stick to Female Mortality line + slight offset for visibility
              let yVal = generalData.mortality_cum_female[i];
              if (yVal === undefined || yVal === null) yVal = 0;
              return {
                  x: d,
                  y: yVal,
                  note: n.note,
                  photo: n.photo,
                  date: d
              };
          }
          return null;
      });

      const notesDataset = {
          label: 'Clinical Notes',
          data: notesPoints,
          type: 'scatter',
          yAxisID: 'y1',
          pointStyle: 'rectRot',
          pointRadius: 6,
          pointHoverRadius: 8,
          backgroundColor: 'purple',
          borderColor: 'purple',
          hidden: true, // Hidden initially
          datalabels: { display: false }
      };

      generalChart = new Chart(document.getElementById('generalChart').getContext('2d'), {
        type: 'bar',
        data: {
          labels: generalData.dates,
          datasets: [
            {
              label: 'Egg Production %',
              data: generalData.egg_prod,
              type: 'line',
              borderColor: 'green',
              yAxisID: 'y',
              datalabels: { display: false }
            },
            {
              label: 'Standard Egg Prod %',
              data: generalData.std_egg_prod,
              type: 'line',
              borderColor: 'darkgreen',
              borderDash: [5, 5],
              pointRadius: 0,
              borderWidth: 2,
              yAxisID: 'y',
              datalabels: { display: false }
            },
            {
              label: 'Mortality Male %',
              data: generalData[mortMKey],
              backgroundColor: 'rgba(54, 162, 235, 0.6)',
              yAxisID: 'y1'
            },
            {
              label: 'Mortality Female %',
              data: generalData[mortFKey],
              backgroundColor: 'rgba(255, 99, 132, 0.6)',
              yAxisID: 'y1'
            },
            {
              label: 'Culls Male %',
              data: generalData[cullMKey],
              backgroundColor: 'rgba(255, 206, 86, 0.6)',
              yAxisID: 'y1'
            },
            {
              label: 'Culls Female %',
              data: generalData[cullFKey],
              backgroundColor: 'rgba(75, 192, 192, 0.6)',
              yAxisID: 'y1'
            },
            {
              label: 'Standard Mort Limit',
              data: baselineData,
              type: 'line',
              borderColor: 'red',
              borderWidth: 2,
              borderDash: [5, 5],
              pointRadius: 0,
              yAxisID: 'y1',
              datalabels: { display: false }
            },
            notesDataset
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          onClick: (e) => {
              const points = generalChart.getElementsAtEventForMode(e, 'nearest', { intersect: true }, true);
              if (points.length) {
                  const firstPoint = points[0];
                  const datasetIndex = firstPoint.datasetIndex;
                  const index = firstPoint.index;
                  const dataset = generalChart.data.datasets[datasetIndex];

                  if (dataset.label === 'Clinical Notes') {
                      const pt = dataset.data[index];
                      if (pt) {
                          showNoteModal(pt.date, pt.note, pt.photo);
                      }
                  }
              }
          },
          interaction: {
            mode: 'index',
            intersect: false,
          },
          scales: {
            y: {
              type: 'linear',
              display: true,
              position: 'right',
              title: { display: true, text: 'Egg Production %' }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'left',
              title: { display: true, text: 'Mortality/Culls %' },
              grid: { drawOnChartArea: false }
            }
          },
          plugins: {
              legend: commonOptions.plugins.legend,
              zoom: commonOptions.plugins.zoom,
              datalabels: { display: false }, // Only show on bars if space permits, but disabled global here
              tooltip: commonOptions.plugins.tooltip
          }
        }
      });
  }

  function applyDateFilter(chartName, filterType) {
      if (chartName === 'general') {
          if (filterType === 'default') window.generalFilterState = (currentMode === 'daily' ? 30 : 10);
          else window.generalFilterState = 'all';
      } else {
          // Both male and female share the filter for bodyweight
          if (filterType === 'default') window.bwFilterState = 10;
          else window.bwFilterState = 'all';
      }
      renderCharts(currentMode);
  }

  function switchMode(mode) {
      // Reset general filter when switching mode
      window.generalFilterState = (mode === 'daily' ? 30 : 10);
      renderCharts(mode);
  }

  // Initial Render
  document.addEventListener('DOMContentLoaded', function() {
      // Tab Change Listener to handle Chart resizing
      const tabEls = document.querySelectorAll('button[data-bs-toggle="tab"]');
      tabEls.forEach(function(tabEl) {
        tabEl.addEventListener('shown.bs.tab', function (event) {
          if (event.target.id === 'charts-tab') {
            if (maleChart) maleChart.resize();
            if (femaleChart) femaleChart.resize();
            if (generalChart) generalChart.resize();
          }
        });
      });

      renderCharts('daily');
  });


  function showNoteModal(date, text, photoUrl) {
      document.getElementById('noteModalTitle').innerText = 'Clinical Note: ' + date;
      document.getElementById('noteModalText').innerText = text;
      document.getElementById('noteModalDate').innerText = date;

      const imgDiv = document.getElementById('noteModalPhoto');
      const img = imgDiv.querySelector('img');
      if (photoUrl) {
          img.src = photoUrl;
          imgDiv.style.display = 'block';
      } else {
          imgDiv.style.display = 'none';
      }

      const modal = new bootstrap.Modal(document.getElementById('noteModal'));
      modal.show();
  }
</script>

{% endblock %}
