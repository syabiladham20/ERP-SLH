{% extends 'base.html' %}

{% block content %}
<h2>Flock Details: {{ flock.batch_id }}</h2>

<div class="card mb-4">
  <div class="card-header">
    Overview
  </div>
  <div class="card-body">
    <div class="row">
      <div class="col-md-3"><strong>House:</strong> {{ flock.house.name }}</div>
      <div class="col-md-3"><strong>Status:</strong> {{ flock.status }}</div>
      <div class="col-md-3"><strong>Phase:</strong> {{ flock.phase }}</div>
      <div class="col-md-3"><strong>Intake Date:</strong> {{ flock.intake_date }}</div>
    </div>
    <div class="row mt-2">
      <div class="col-md-3"><strong>Start Population:</strong> {{ flock.intake_male }} M / {{ flock.intake_female }} F</div>
      <div class="col-md-3"><strong>DOA:</strong> {{ flock.doa_male }} M / {{ flock.doa_female }} F</div>
    </div>
  </div>
</div>

{% if weekly_data %}
<h3>Weekly Summary</h3>
<div class="table-responsive mb-4">
  <table class="table table-bordered table-sm">
    <thead class="table-light">
      <tr>
        <th>Week</th>
        <th>Mortality (M/F)</th>
        <th>Culls (M/F)</th>
        <th>Eggs</th>
        <th>Avg BW (M/F)</th>
      </tr>
    </thead>
    <tbody>
      {% for w in weekly_data %}
      <tr>
        <td>{{ w.week }}</td>
        <td>{{ w.mortality_male }} / {{ w.mortality_female }}</td>
        <td>{{ w.culls_male }} / {{ w.culls_female }}</td>
        <td>{{ w.eggs }}</td>
        <td>{{ "%.2f"|format(w.avg_bw_male) }} / {{ "%.2f"|format(w.avg_bw_female) }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endif %}

<!-- Male Chart -->
<div class="card mb-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    Performance Charts
    <div>
        <a href="{{ url_for('flock_dashboard', id=flock.id) }}" class="btn btn-sm btn-success me-2">KPI Dashboard</a>
        <a href="{{ url_for('flock_custom_dashboard', id=flock.id) }}" class="btn btn-sm btn-warning me-2">Custom Dashboard</a>
        <a href="{{ url_for('flock_charts', id=flock.id) }}" class="btn btn-sm btn-primary me-2">Advanced Charts</a>
        <a href="{{ url_for('flock_hatchability', id=flock.id) }}" class="btn btn-sm btn-info text-white me-2">Hatchability</a>
        <a href="{{ url_for('health_log', flock_id=flock.id) }}" class="btn btn-sm btn-danger">Health Log</a>
    </div>
  </div>
  <div class="card-body">
    <canvas id="maleChart"></canvas>
  </div>
</div>

<!-- Female Chart -->
<div class="card mb-4">
  <div class="card-header">Female Statistics (BW & Uniformity)</div>
  <div class="card-body">
    <canvas id="femaleChart"></canvas>
  </div>
</div>

<!-- General Performance Chart -->
<div class="card mb-4">
  <div class="card-header">General Performance</div>
  <div class="card-body">
    <canvas id="generalChart"></canvas>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script>
  // Register plugin
  Chart.register(ChartDataLabels);

  const chartData = {{ chart_data | tojson }};

  // --- Common Options ---
  const commonOptions = {
      responsive: true,
      spanGaps: true, // Connect lines if nulls exist
      interaction: {
        mode: 'index',
        intersect: false,
      },
      plugins: {
          datalabels: {
              align: 'top',
              anchor: 'end',
              formatter: function(value, context) {
                  return value ? value : '';
              },
              font: { weight: 'bold', size: 10 },
              color: '#333'
          }
      }
  };

  // --- Male Chart ---
  const maleDatasets = [];
  const colorsM = ['#36A2EB', '#0056b3', '#4bc0c0', '#198754', '#0dcaf0', '#6610f2', '#6f42c1', '#d63384'];

  // Dynamic Partitions 1-8
  for (let i = 1; i <= 8; i++) {
      let key = 'bw_M' + i;
      if (chartData[key] && chartData[key].some(val => val !== null)) {
          maleDatasets.push({
            label: 'BW M' + i,
            data: chartData[key],
            borderColor: colorsM[i-1] || '#333',
            backgroundColor: colorsM[i-1] || '#333',
            tension: 0.1,
            yAxisID: 'y'
          });
      }
  }

  // Add Standard if available (Legacy fallback check included in backend, but here we assume key exists)
  maleDatasets.push({
      label: 'Std BW',
      data: chartData.bw_male_std,
      borderColor: '#000000',
      borderDash: [5, 5],
      pointRadius: 0,
      borderWidth: 2,
      yAxisID: 'y',
      datalabels: { display: false }
  });

  maleDatasets.push({
      label: 'Uniformity %',
      data: chartData.unif_male,
      borderColor: '#FFCE56',
      borderDash: [2, 2],
      pointStyle: 'rectRot',
      yAxisID: 'y1'
  });

  new Chart(document.getElementById('maleChart').getContext('2d'), {
    type: 'line',
    data: {
      labels: chartData.dates,
      datasets: maleDatasets
    },
    options: {
        ...commonOptions,
        scales: {
            y: {
                type: 'linear',
                display: true,
                position: 'left',
                title: { display: true, text: 'Body Weight (g)' }
            },
            y1: {
                type: 'linear',
                display: true,
                position: 'right',
                title: { display: true, text: 'Uniformity %' },
                grid: { drawOnChartArea: false } // independent grid
            }
        }
    }
  });

  // --- Female Chart ---
  const femaleDatasets = [];
  const colorsF = ['#FF6384', '#FF9F40', '#FFCD56', '#4BC0C0', '#9966FF', '#C9CBCF', '#fd7e14', '#20c997'];

  for (let i = 1; i <= 8; i++) {
      let key = 'bw_F' + i;
      if (chartData[key] && chartData[key].some(val => val !== null)) {
          femaleDatasets.push({
            label: 'BW F' + i,
            data: chartData[key],
            borderColor: colorsF[i-1] || '#333',
            backgroundColor: colorsF[i-1] || '#333',
            yAxisID: 'y'
          });
      }
  }

  femaleDatasets.push({
      label: 'Std BW',
      data: chartData.bw_female_std,
      borderColor: '#000000',
      borderDash: [5, 5],
      pointRadius: 0,
      borderWidth: 2,
      yAxisID: 'y',
      datalabels: { display: false }
  });

  femaleDatasets.push({
      label: 'Uniformity %',
      data: chartData.unif_female,
      borderColor: '#9966FF',
      borderDash: [2, 2],
      pointStyle: 'rectRot',
      yAxisID: 'y1'
  });

  new Chart(document.getElementById('femaleChart').getContext('2d'), {
    type: 'line',
    data: {
      labels: chartData.dates,
      datasets: femaleDatasets
    },
    options: {
        ...commonOptions,
        scales: {
            y: {
                type: 'linear',
                display: true,
                position: 'left',
                title: { display: true, text: 'Body Weight (g)' }
            },
            y1: {
                type: 'linear',
                display: true,
                position: 'right',
                title: { display: true, text: 'Uniformity %' },
                grid: { drawOnChartArea: false }
            }
        }
    }
  });

  // --- General Chart ---
  new Chart(document.getElementById('generalChart').getContext('2d'), {
    type: 'line',
    data: {
      labels: chartData.dates,
      datasets: [
        {
          label: 'Egg Production %',
          data: chartData.egg_prod,
          borderColor: 'green',
          yAxisID: 'y',
          datalabels: { display: false }
        },
        {
          label: 'Cum. Mortality Male %',
          data: chartData.mortality_cum_male,
          borderColor: 'blue',
          yAxisID: 'y1',
          datalabels: { display: false }
        },
        {
          label: 'Cum. Mortality Female %',
          data: chartData.mortality_cum_female,
          borderColor: 'red',
          yAxisID: 'y1',
          datalabels: { display: false }
        }
      ]
    },
    options: {
      responsive: true,
      interaction: {
        mode: 'index',
        intersect: false,
      },
      scales: {
        y: {
          type: 'linear',
          display: true,
          position: 'left',
          title: { display: true, text: 'Egg Production %' }
        },
        y1: {
          type: 'linear',
          display: true,
          position: 'right',
          title: { display: true, text: 'Mortality %' },
          grid: {
            drawOnChartArea: false
          }
        }
      },
      plugins: {
          datalabels: { display: false }
      }
    }
  });
</script>

<h3>Daily Logs</h3>
<div class="table-responsive">
  <table class="table table-striped table-sm">
    <thead>
      <tr>
        <th>Date</th>
        <th>Mortality (M/F)</th>
        <th>Feed (M/F)</th>
        <th>Water (Cal 24h)</th>
        <th>Eggs</th>
        <th>BW (M/F)</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for log in logs %}
      <tr>
        <td>{{ log.date }}</td>
        <td>{{ log.mortality_male }} / {{ log.mortality_female }}</td>
        <td>{{ log.feed_male_gp_bird }} / {{ log.feed_female_gp_bird }}</td>
        <td>{{ "%.0f"|format(log.water_intake_calculated) }} L</td>
        <td>{{ log.eggs_collected }}</td>
        <td>{{ log.body_weight_male }} / {{ log.body_weight_female }}</td>
        <td>
          <a href="{{ url_for('edit_daily_log', id=log.id) }}" class="btn btn-sm btn-outline-primary">Edit</a>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}
