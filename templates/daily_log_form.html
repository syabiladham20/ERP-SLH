{% extends 'base.html' %}

{% block content %}
<h2>{{ 'Edit Daily Log' if log else 'Daily Data Entry' }}</h2>

{% if not houses and not log %}
  <div class="alert alert-warning">
    No active flocks found. Please <a href="{{ url_for('manage_flocks') }}">create a flock</a> first.
  </div>
{% else %}
  <form method="POST" enctype="multipart/form-data">
    <div class="card mb-3">
      <div class="card-header sticky-header bg-primary text-white">General Info</div>
      <div class="card-body">
        <div class="mb-3">
          <label for="house_id" class="form-label">House</label>
          <select class="form-select" id="house_id" name="house_id" required onchange="onSelectionChange()">
            {% for house in houses %}
              {# Pass phase info in data attribute #}
              {% set flock = house.flocks|selectattr("status", "equalto", "Active")|first %}
              <option value="{{ house.id }}"
                      data-phase="{{ flock.phase if flock else 'Rearing' }}"
                      {{ 'selected' if (log and log.flock.house_id == house.id) or (selected_house_id == house.id) else '' }}>
                {{ house.name }}
              </option>
            {% endfor %}
          </select>
          {% if log %}
             <input type="hidden" id="phase_val" value="{{ log.flock.phase }}">
          {% endif %}
        </div>
        <div class="mb-3">
          <label for="date" class="form-label">Date</label>
          <div class="input-group">
              <input type="date" class="form-control" id="date" name="date" required
                     value="{{ log.date if log else (selected_date if selected_date else date_today) }}"
                     onchange="onSelectionChange()">
              {% if log %}
                  <span class="input-group-text text-success fw-bold" title="Data loaded from existing log">âœ… Data Loaded</span>
              {% endif %}
          </div>
        </div>
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-header sticky-header bg-info text-dark">Mortality & Culls (Production)</div>
      <div class="card-body">
        <div class="row">
          <div class="col-6 mb-2">
            <label class="form-label">Mortality Male (Prod)</label>
            <input type="number" class="form-control" name="mortality_male" value="{{ log.mortality_male if log else 0 }}">
          </div>
          <div class="col-6 mb-2">
            <label class="form-label">Mortality Female (Prod)</label>
            <input type="number" class="form-control" name="mortality_female" value="{{ log.mortality_female if log else 0 }}">
          </div>
          <div class="col-6 mb-2">
            <label class="form-label">Culls Male (Prod)</label>
            <input type="number" class="form-control" name="culls_male" value="{{ log.culls_male if log else 0 }}">
          </div>
          <div class="col-6 mb-2">
            <label class="form-label">Culls Female (Prod)</label>
            <input type="number" class="form-control" name="culls_female" value="{{ log.culls_female if log else 0 }}">
          </div>
        </div>

        <div class="mt-3">
            <button type="button" class="btn btn-sm btn-outline-secondary w-100 mb-2" data-bs-toggle="collapse" data-bs-target="#hospitalSection">
                Toggle Hospital Data (Male & Female)
            </button>
            <div class="collapse" id="hospitalSection">
                <div class="card card-body bg-light">
                    <h6 class="text-dark">Hospital Mortality & Culls</h6>
                    <div class="row">
                        <div class="col-6 mb-2">
                            <label class="form-label small">Mortality Male (Hosp)</label>
                            <input type="number" class="form-control form-control-sm" name="mortality_male_hosp" value="{{ log.mortality_male_hosp if log else 0 }}">
                        </div>
                        <div class="col-6 mb-2">
                            <label class="form-label small">Mortality Female (Hosp)</label>
                            <input type="number" class="form-control form-control-sm" name="mortality_female_hosp" value="{{ log.mortality_female_hosp if log else 0 }}">
                        </div>
                        <div class="col-6 mb-2">
                            <label class="form-label small">Culls Male (Hosp)</label>
                            <input type="number" class="form-control form-control-sm" name="culls_male_hosp" value="{{ log.culls_male_hosp if log else 0 }}">
                        </div>
                        <div class="col-6 mb-2">
                            <label class="form-label small">Culls Female (Hosp)</label>
                            <input type="number" class="form-control form-control-sm" name="culls_female_hosp" value="{{ log.culls_female_hosp if log else 0 }}">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-2">
            <button type="button" class="btn btn-sm btn-outline-secondary w-100 mb-2" data-bs-toggle="collapse" data-bs-target="#transferSection">
                Toggle Transfers (In/Out Production)
            </button>
            <div class="collapse" id="transferSection">
                <div class="card card-body bg-light">
                    <h6 class="text-dark">Transfers</h6>
                    <div class="row">
                        <div class="col-6 mb-2">
                            <label class="form-label small">Males -> To Hospital</label>
                            <input type="number" class="form-control form-control-sm" name="males_moved_to_hosp" value="{{ log.males_moved_to_hosp if log else 0 }}">
                        </div>
                        <div class="col-6 mb-2">
                            <label class="form-label small">Females -> To Hospital</label>
                            <input type="number" class="form-control form-control-sm" name="females_moved_to_hosp" value="{{ log.females_moved_to_hosp if log else 0 }}">
                        </div>
                        <div class="col-6 mb-2">
                            <label class="form-label small">Males -> To Production</label>
                            <input type="number" class="form-control form-control-sm" name="males_moved_to_prod" value="{{ log.males_moved_to_prod if log else 0 }}">
                        </div>
                        <div class="col-6 mb-2">
                            <label class="form-label small">Females -> To Production</label>
                            <input type="number" class="form-control form-control-sm" name="females_moved_to_prod" value="{{ log.females_moved_to_prod if log else 0 }}">
                        </div>
                    </div>
                </div>
            </div>
        </div>

      </div>
    </div>

    <div class="card mb-3">
      <div class="card-header sticky-header bg-success text-white">Feed</div>
      <div class="card-body">
        <div class="row mb-3">
            <div class="col-md-4">
                <label class="form-label">Feed Program</label>
                <select class="form-select" name="feed_program">
                    <option value="Full Feed" {{ 'selected' if log and log.feed_program == 'Full Feed' else '' }}>Full Feed</option>
                    <option value="Skip-a-day" {{ 'selected' if log and log.feed_program == 'Skip-a-day' else '' }}>Skip-a-day</option>
                    <option value="2/1" {{ 'selected' if log and log.feed_program == '2/1' else '' }}>2/1</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">Male Feed Code</label>
                <select class="form-select" name="feed_code_male_id">
                    <option value="">-- Select Code --</option>
                    {% for fc in feed_codes %}
                    <option value="{{ fc.id }}" {{ 'selected' if log and log.feed_code_male_id == fc.id else '' }}>{{ fc.code }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">Female Feed Code</label>
                <select class="form-select" name="feed_code_female_id">
                    <option value="">-- Select Code --</option>
                    {% for fc in feed_codes %}
                    <option value="{{ fc.id }}" {{ 'selected' if log and log.feed_code_female_id == fc.id else '' }}>{{ fc.code }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="row">
          <div class="col-6 mb-2">
            <label class="form-label">Male Feed (g/bird)</label>
            <input type="number" step="0.01" class="form-control" name="feed_male_gp_bird" value="{{ log.feed_male_gp_bird if log and log.feed_male_gp_bird else '' }}">
          </div>
          <div class="col-6 mb-2">
            <label class="form-label">Female Feed (g/bird)</label>
            <input type="number" step="0.01" class="form-control" name="feed_female_gp_bird" value="{{ log.feed_female_gp_bird if log and log.feed_female_gp_bird else '' }}">
          </div>
        </div>
        <div class="row">
          <div class="col-6 mb-2">
            <label class="form-label">Feed Cleanup Start</label>
            <input type="time" class="form-control" name="feed_cleanup_start" value="{{ log.feed_cleanup_start if log else '' }}">
          </div>
          <div class="col-6 mb-2">
            <label class="form-label">Feed Cleanup End</label>
            <input type="time" class="form-control" name="feed_cleanup_end" value="{{ log.feed_cleanup_end if log else '' }}">
          </div>
        </div>
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-header sticky-header bg-info text-white">Water Readings (Enter Whole Numbers)</div>
      <div class="card-body">
        <div class="row">
          <div class="col-4 mb-2">
            <label class="form-label">Reading 1</label>
            <input type="number" class="form-control" name="water_reading_1" value="{{ log.water_reading_1 if log else 0 }}" onchange="calculateWater()">
          </div>
          <div class="col-4 mb-2">
            <label class="form-label">Reading 2</label>
            <input type="number" class="form-control" name="water_reading_2" value="{{ log.water_reading_2 if log else 0 }}" onchange="calculateWater()">
          </div>
          <div class="col-4 mb-2">
            <label class="form-label">Reading 3</label>
            <input type="number" class="form-control" name="water_reading_3" value="{{ log.water_reading_3 if log else 0 }}" onchange="calculateWater()">
          </div>
        </div>
        <div class="mb-3">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" name="flushing" id="flushing" {{ 'checked' if log and log.flushing else '' }}>
                <label class="form-check-label" for="flushing">
                    Flushing Active?
                </label>
            </div>
        </div>
        <small class="text-muted">
          12h Consumption: <span id="water_12h">0</span> Liters
        </small>
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-header sticky-header bg-warning text-dark">Production</div>
      <div class="card-body">
        <div class="mb-3">
          <label class="form-label">Eggs Collected</label>
          <input type="number" class="form-control" name="eggs_collected" value="{{ log.eggs_collected if log else 0 }}">
        </div>
        <div class="mb-3">
          <label class="form-label">Egg Weight (avg)</label>
          <input type="number" step="0.01" class="form-control" name="egg_weight" value="{{ log.egg_weight if log else 0 }}">
        </div>
        <label class="form-label">Cull Eggs</label>
        <div class="row">
          <div class="col-3"><input type="number" class="form-control form-control-sm" name="cull_eggs_jumbo" placeholder="Jumbo" value="{{ log.cull_eggs_jumbo if log else '' }}"></div>
          <div class="col-3"><input type="number" class="form-control form-control-sm" name="cull_eggs_small" placeholder="Small" value="{{ log.cull_eggs_small if log else '' }}"></div>
          <div class="col-3"><input type="number" class="form-control form-control-sm" name="cull_eggs_abnormal" placeholder="Abnormal" value="{{ log.cull_eggs_abnormal if log else '' }}"></div>
          <div class="col-3"><input type="number" class="form-control form-control-sm" name="cull_eggs_crack" placeholder="Crack" value="{{ log.cull_eggs_crack if log else '' }}"></div>
        </div>
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-header sticky-header bg-secondary text-white d-flex justify-content-between align-items-center">
        <span>Body Weight & Uniformity</span>
        <div class="form-check form-switch text-light">
           <input class="form-check-input" type="checkbox" id="is_weighing_day" name="is_weighing_day" onchange="togglePartitions()" {{ 'checked' if log and log.is_weighing_day else '' }}>
           <label class="form-check-label" for="is_weighing_day">Weighing Day</label>
        </div>
      </div>
      <div class="card-body">
        <!-- Standard BW -->
        <div class="row mb-3" id="standard_bw_section">
           <div class="col-6">
             <label class="form-label text-muted small">Std Male BW</label>
             <input type="number" step="0.01" class="form-control form-control-sm" name="standard_bw_male" value="{{ log.standard_bw_male if log and log.standard_bw_male else '' }}">
           </div>
           <div class="col-6">
             <label class="form-label text-muted small">Std Female BW</label>
             <input type="number" step="0.01" class="form-control form-control-sm" name="standard_bw_female" value="{{ log.standard_bw_female if log and log.standard_bw_female else '' }}">
           </div>
        </div>

        <!-- Partitions Section (Hidden unless Weighing Day & Rearing) -->
        <div id="partitions_section" style="display:none;">
            <div class="row">
                <!-- Male Section -->
                <div class="col-md-6 border-end">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="text-primary mb-0">Male Partitions (Max 8)</h6>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="addPartition('M')">+ Add</button>
                    </div>
                    {% for i in range(1, 9) %}
                    {% set bw_val = get_partition_val(log, 'M' ~ i, 'bw') %}
                    {% set uni_val = get_partition_val(log, 'M' ~ i, 'uni') %}
                    <!-- If existing log has data, show it. Otherwise hide P3-P8 initially -->
                    {% set show_style = 'display:flex;' if (bw_val > 0 or i <= 2) else 'display:none;' %}
                    <div class="row mb-2 partition-row-M" id="row_M{{i}}" style="{{ show_style }}">
                        <div class="col-1 d-flex align-items-center"><span class="badge bg-light text-dark">M{{i}}</span></div>
                        <div class="col-4"><input type="number" step="0.01" class="form-control form-control-sm" name="bw_M{{i}}" placeholder="BW" value="{{ bw_val or '' }}" onchange="calcAvg()"></div>
                        <div class="col-4"><input type="number" step="0.01" class="form-control form-control-sm" name="uni_M{{i}}" placeholder="Unif" value="{{ uni_val or '' }}" onchange="calcAvg()"></div>
                        <div class="col-2"><button type="button" class="btn btn-sm text-danger" onclick="removePartition('M', {{i}})">&times;</button></div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Female Section -->
                <div class="col-md-6">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="text-danger mb-0">Female Partitions (Max 8)</h6>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="addPartition('F')">+ Add</button>
                    </div>
                    {% for i in range(1, 9) %}
                    {% set bw_val = get_partition_val(log, 'F' ~ i, 'bw') %}
                    {% set uni_val = get_partition_val(log, 'F' ~ i, 'uni') %}
                    {% set show_style = 'display:flex;' if (bw_val > 0 or i <= 4) else 'display:none;' %}
                    <div class="row mb-2 partition-row-F" id="row_F{{i}}" style="{{ show_style }}">
                        <div class="col-1 d-flex align-items-center"><span class="badge bg-light text-dark">F{{i}}</span></div>
                        <div class="col-4"><input type="number" step="0.01" class="form-control form-control-sm" name="bw_F{{i}}" placeholder="BW" value="{{ bw_val or '' }}" onchange="calcAvg()"></div>
                        <div class="col-4"><input type="number" step="0.01" class="form-control form-control-sm" name="uni_F{{i}}" placeholder="Unif" value="{{ uni_val or '' }}" onchange="calcAvg()"></div>
                        <div class="col-2"><button type="button" class="btn btn-sm text-danger" onclick="removePartition('F', {{i}})">&times;</button></div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            <hr>
        </div>

        <div class="row" id="average_section">
          <div class="col-6 mb-2">
            <label class="form-label">Avg Male BW</label>
            <input type="number" step="0.01" class="form-control" name="body_weight_male" id="body_weight_male" value="{{ log.body_weight_male if log and log.body_weight_male else '' }}">
          </div>
          <div class="col-6 mb-2">
            <label class="form-label">Avg Female BW</label>
            <input type="number" step="0.01" class="form-control" name="body_weight_female" id="body_weight_female" value="{{ log.body_weight_female if log and log.body_weight_female else '' }}">
          </div>
          <div class="col-6 mb-2">
            <label class="form-label">Avg Male Unif %</label>
            <input type="number" step="0.01" class="form-control" name="uniformity_male" id="uniformity_male" value="{{ log.uniformity_male if log and log.uniformity_male else '' }}">
          </div>
          <div class="col-6 mb-2">
            <label class="form-label">Avg Female Unif %</label>
            <input type="number" step="0.01" class="form-control" name="uniformity_female" id="uniformity_female" value="{{ log.uniformity_female if log and log.uniformity_female else '' }}">
          </div>
        </div>
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-header sticky-header bg-dark text-white">Other & Clinical</div>
      <div class="card-body">
        <div class="row mb-3">
          <div class="col-6">
            <label class="form-label">Light On</label>
            <input type="time" class="form-control" name="light_on_time" value="{{ log.light_on_time if log else '' }}">
          </div>
          <div class="col-6">
            <label class="form-label">Light Off</label>
            <input type="time" class="form-control" name="light_off_time" value="{{ log.light_off_time if log else '' }}">
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label">Clinical Notes</label>
          <textarea class="form-control" name="clinical_notes" rows="3">{{ log.clinical_notes if log else '' }}</textarea>
        </div>
        <div class="mb-3">
          <label class="form-label">Photo Upload (Post-Mortem)</label>
          <input type="file" class="form-control" name="photo">
          {% if log and log.photo_path %}
            <small class="text-muted">Current photo: {{ log.photo_path }}</small>
          {% endif %}
        </div>
      </div>
    </div>

    {% if vaccines_due %}
    <div class="card mb-3 border-info">
      <div class="card-header sticky-header bg-info text-white">Vaccinations (Pending / Done Today)</div>
      <div class="card-body">
        <div class="alert alert-light border small mb-2">
            Below are vaccines scheduled around this date or marked as completed today.
            Check the box to mark as <strong>Completed on {{ log.date if log else selected_date }}</strong>.
        </div>
        <div class="table-responsive">
            <table class="table table-sm table-striped">
                <thead>
                    <tr>
                        <th>Status</th>
                        <th>Age</th>
                        <th>Vaccine</th>
                        <th>Est. Date</th>
                        <th>Mark Completed</th>
                    </tr>
                </thead>
                <tbody>
                    {% for v in vaccines_due %}
                    <tr class="{{ 'table-success' if v.actual_date else '' }}">
                        <td>
                            <input type="hidden" name="vaccine_present_ids" value="{{ v.id }}">
                            {% if v.actual_date %}
                                <span class="badge bg-success">Done</span>
                            {% else %}
                                <span class="badge bg-warning text-dark">Pending</span>
                            {% endif %}
                        </td>
                        <td>{{ v.age_code }}</td>
                        <td>{{ v.vaccine_name }}</td>
                        <td>{{ v.est_date }}</td>
                        <td>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="vaccine_completed_ids" value="{{ v.id }}" id="vac_{{ v.id }}" {{ 'checked' if v.actual_date else '' }}>
                                <label class="form-check-label" for="vac_{{ v.id }}">Completed</label>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
      </div>
    </div>
    {% endif %}

    <div class="card mb-3">
      <div class="card-header sticky-header bg-danger text-white">Medication Record (Optional)</div>
      <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
        <span>Medication Record (Optional)</span>
        <button type="button" class="btn btn-sm btn-light text-danger fw-bold" onclick="addMedicationRow()">+ Add Medication</button>
      </div>
      <div class="card-body">
        <div class="alert alert-light border small mb-3">
            Fill this section only if you want to record a NEW medication usage or program starting/occurring today.
            You can add multiple medications.
        </div>

        <div id="medication_container">
            <!-- Dynamic rows will be added here -->
        </div>

        <!-- Template Row (Hidden) -->
        <div id="medication_template" style="display:none;">
            <div class="medication-row border-bottom pb-3 mb-3">
                <div class="d-flex justify-content-between mb-2">
                    <h6 class="text-danger">Medication Entry <span class="med-index">1</span></h6>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeMedicationRow(this)">Remove</button>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-2">
                        <label class="form-label">Drug Name</label>
                        <select class="form-select med-input med-select" name="med_inventory_id[]" onchange="toggleMedInput(this)">
                            <option value="">-- Select from Inventory --</option>
                            {% for item in medication_inventory %}
                            <option value="{{ item.id }}" data-unit="{{ item.unit }}">{{ item.name }} ({{ item.current_stock }} {{ item.unit }})</option>
                            {% endfor %}
                            <option value="MANUAL">-- Enter Manually --</option>
                        </select>
                        <input type="text" class="form-control med-input med-manual mt-1" name="med_drug_name[]" placeholder="Enter Name" style="display:none;">
                    </div>
                    <div class="col-md-2 mb-2">
                        <label class="form-label">Dosage</label>
                        <input type="text" class="form-control med-input" name="med_dosage[]" placeholder="e.g. 10ml/100L">
                    </div>
                    <div class="col-md-2 mb-2">
                        <label class="form-label">Amount Used</label>
                        <div class="input-group">
                            <input type="number" step="0.01" class="form-control med-input" name="med_amount_qty[]" placeholder="Qty">
                            <span class="input-group-text med-unit">-</span>
                        </div>
                        <input type="text" class="form-control med-input mt-1" name="med_amount_used[]" placeholder="Text (e.g. 500ml)">
                    </div>
                    <div class="col-md-2 mb-2">
                        <label class="form-label">Start Date</label>
                        <input type="date" class="form-control med-input" name="med_start_date[]" value="{{ log.date if log else '' }}">
                    </div>
                     <div class="col-md-2 mb-2">
                        <label class="form-label">End Date</label>
                        <input type="date" class="form-control med-input" name="med_end_date[]">
                    </div>
                </div>
                <div class="mb-2">
                     <label class="form-label">Remarks</label>
                     <input type="text" class="form-control med-input" name="med_remarks[]" placeholder="Notes / Withdrawal Period">
                </div>
            </div>
        </div>

      </div>
    </div>

    <button type="submit" class="btn btn-primary w-100 mb-5">{{ 'Update Log' if log else 'Submit Log' }}</button>
  </form>
  
  <script>
    {% if not log and not selected_date %}
    // Set default date to today only for new logs (if no date selected)
    document.getElementById('date').valueAsDate = new Date();
    {% endif %}

    function onSelectionChange() {
        {% if request.endpoint == 'daily_log' %}
        let houseId = document.getElementById('house_id').value;
        let dateVal = document.getElementById('date').value;
        if (houseId && dateVal) {
             // Reload page with query params to check for existing data
             window.location.href = "{{ url_for('daily_log') }}?house_id=" + houseId + "&date=" + dateVal;
             return;
        }
        {% endif %}
        updatePhase();
    }

    function calculateWater() {
        // Get values (integers)
        let r1 = parseFloat(document.getElementsByName('water_reading_1')[0].value) || 0;
        let r3 = parseFloat(document.getElementsByName('water_reading_3')[0].value) || 0;
        
        // Convert to real values (divide by 100)
        let r1_real = r1 / 100;
        let r3_real = r3 / 100;
        
        // 12h Consumption = (R3 - R1) * 1000 Liters
        // Wait, unit: meter cubic. 1 m3 = 1000 L.
        // Formula: (R3 - R1) * 1000.
        
        let consumption12h = (r3_real - r1_real) * 1000;
        document.getElementById('water_12h').innerText = consumption12h.toFixed(2);
    }

    // Phase & Partition Logic
    function updatePhase() {
        let houseSelect = document.getElementById('house_id');
        let phase = 'Rearing';
        if (houseSelect && houseSelect.selectedIndex >= 0) {
            let option = houseSelect.options[houseSelect.selectedIndex];
            phase = option.getAttribute('data-phase') || 'Rearing';
        } else {
            // Fallback (though houseSelect should exist now)
            let phaseInput = document.getElementById('phase_val');
            phase = phaseInput ? phaseInput.value : 'Rearing';
        }

        let partitionsDiv = document.getElementById('partitions_section');
        let avgDiv = document.getElementById('average_section');
        let weighingCheck = document.getElementById('is_weighing_day');

        if (phase === 'Production') {
            partitionsDiv.style.display = 'none';
            avgDiv.style.display = 'flex'; // Show row
            setAvgReadonly(false);
        } else {
            togglePartitions();
        }
    }

    function togglePartitions() {
        let isWeighing = document.getElementById('is_weighing_day').checked;
        let partitionsDiv = document.getElementById('partitions_section');
        let avgDiv = document.getElementById('average_section');

        // Double check phase
        let houseSelect = document.getElementById('house_id');
        let phase = 'Rearing';
        if (houseSelect && houseSelect.selectedIndex >= 0) {
             phase = houseSelect.options[houseSelect.selectedIndex].getAttribute('data-phase');
        } else if (document.getElementById('phase_val')) {
             phase = document.getElementById('phase_val').value;
        }

        if (phase === 'Production') {
            partitionsDiv.style.display = 'none';
            avgDiv.style.display = 'flex';
            setAvgReadonly(false);
            return;
        }

        if (isWeighing) {
            partitionsDiv.style.display = 'block';
            avgDiv.style.display = 'flex';
            setAvgReadonly(true);
            calcAvg();
        } else {
            partitionsDiv.style.display = 'none';
            // "hide bodyweight column if there is no weighing that day"
            avgDiv.style.display = 'none';
        }
    }

    function setAvgReadonly(readonly) {
        let ids = ['body_weight_male', 'body_weight_female', 'uniformity_male', 'uniformity_female'];
        ids.forEach(id => {
            let el = document.getElementById(id);
            if(readonly) {
                el.setAttribute('readonly', true);
                el.classList.add('bg-light');
            } else {
                el.removeAttribute('readonly');
                el.classList.remove('bg-light');
            }
        });
    }

    function addPartition(sex) {
        // Find first hidden row
        for(let i=1; i<=8; i++) {
            let row = document.getElementById('row_' + sex + i);
            if(row && row.style.display === 'none') {
                row.style.display = 'flex';
                break;
            }
        }
    }

    function removePartition(sex, index) {
        let row = document.getElementById('row_' + sex + index);
        if(row) {
            row.style.display = 'none';
            // Clear values
            let inputs = row.getElementsByTagName('input');
            for(let inp of inputs) {
                inp.value = 0;
            }
            calcAvg();
        }
    }

    function calcAvg() {
        if (document.getElementById('partitions_section').style.display === 'none') return;

        // Male
        let m_sum = 0, m_cnt = 0;
        let mu_sum = 0;

        for(let i=1; i<=8; i++) {
            let row = document.getElementById('row_M' + i);
            if(row && row.style.display !== 'none') {
                let bw = parseFloat(document.getElementsByName('bw_M' + i)[0].value) || 0;
                let uni = parseFloat(document.getElementsByName('uni_M' + i)[0].value) || 0;
                if(bw > 0) {
                    m_sum += bw;
                    m_cnt++;
                    mu_sum += uni;
                }
            }
        }
        document.getElementById('body_weight_male').value = m_cnt > 0 ? (m_sum / m_cnt).toFixed(2) : '';
        document.getElementById('uniformity_male').value = m_cnt > 0 ? (mu_sum / m_cnt).toFixed(2) : '';

        // Female
        let f_sum = 0, f_cnt = 0;
        let fu_sum = 0;

        for(let i=1; i<=8; i++) {
            let row = document.getElementById('row_F' + i);
            if(row && row.style.display !== 'none') {
                let bw = parseFloat(document.getElementsByName('bw_F' + i)[0].value) || 0;
                let uni = parseFloat(document.getElementsByName('uni_F' + i)[0].value) || 0;
                if(bw > 0) {
                    f_sum += bw;
                    f_cnt++;
                    fu_sum += uni;
                }
            }
        }
        document.getElementById('body_weight_female').value = f_cnt > 0 ? (f_sum / f_cnt).toFixed(2) : '';
        document.getElementById('uniformity_female').value = f_cnt > 0 ? (fu_sum / f_cnt).toFixed(2) : '';
    }

    // Medication Row Management
    let medIndex = 0;

    function addMedicationRow() {
        medIndex++;
        let container = document.getElementById('medication_container');
        let template = document.getElementById('medication_template').innerHTML;

        let newRow = document.createElement('div');
        newRow.innerHTML = template;

        // Update index label
        newRow.querySelector('.med-index').textContent = medIndex;

        container.appendChild(newRow.firstElementChild);
    }

    function removeMedicationRow(btn) {
        let row = btn.closest('.medication-row');
        row.remove();
    }

    function toggleMedInput(select) {
        let row = select.closest('.row');
        let manualInput = row.querySelector('.med-manual');
        let unitLabel = row.querySelector('.med-unit');

        if (select.value === 'MANUAL') {
            manualInput.style.display = 'block';
            unitLabel.textContent = '-';
        } else {
            manualInput.style.display = 'none';
            // Set manual input value to empty so it doesn't override logic if we were using it logic-wise
            manualInput.value = "";

            // Update Unit Label
            if (select.selectedIndex >= 0) {
                let unit = select.options[select.selectedIndex].getAttribute('data-unit');
                unitLabel.textContent = unit || '-';
            }
        }
    }

    // Initialize
    window.onload = function() {
        updatePhase();
        // Add one empty medication row by default? No, user requested "add". Let's start empty or with one?
        // Let's start with one empty row for convenience, or zero?
        // Existing behavior was one set of fields. Let's add one row by default.
        addMedicationRow();
    };
  </script>
{% endif %}
{% endblock %}
