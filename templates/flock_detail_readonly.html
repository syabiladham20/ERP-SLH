{% extends 'base.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2>Flock Details: {{ flock.house.name }}</h2>
  <div class="dropdown" style="z-index: 2000;">
    <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton1" data-bs-toggle="dropdown" aria-expanded="false">
      Switch House
    </button>
    <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1" style="max-height: 300px; overflow-y: auto;">
      {% for f in active_flocks %}
      <li><a class="dropdown-item" href="{{ url_for('executive_flock_detail', id=f.id) }}">{{ f.house.name }}</a></li>
      {% endfor %}
    </ul>
  </div>
</div>

<!-- Overview Card -->
<div class="card mb-4">
  <div class="card-header sticky-header">
    Overview
  </div>
  <div class="card-body">
    <div class="row">
      <div class="col-md-3"><strong>House:</strong> {{ flock.house.name }}</div>
      <div class="col-md-3"><strong>Status:</strong> {{ flock.status }}</div>
      <div class="col-md-3"><strong>Phase:</strong> {{ flock.phase }}</div>
      <div class="col-md-3"><strong>Intake Date:</strong> {{ flock.intake_date | date_fmt }}</div>
    </div>
    <div class="row mt-2">
      <div class="col-md-3"><strong>Intake:</strong> {{ flock.intake_male }} M / {{ flock.intake_female }} F</div>
      <div class="col-md-3"><strong>DOA:</strong> {{ flock.doa_male }} M / {{ flock.doa_female }} F</div>
      <div class="col-md-3 border-start">
          <strong>Current Prod:</strong> {{ current_stats.male_prod }} M / {{ current_stats.female_prod }} F
          <br>
          <small class="text-muted">Male Ratio: {{ "%.2f"|format(current_stats.male_ratio) }}%</small>
      </div>
      <div class="col-md-3">
          <strong>Current Hosp:</strong> {{ current_stats.male_hosp }} M / {{ current_stats.female_hosp }} F
      </div>
    </div>
  </div>
</div>

<!-- Navigation Tabs -->
<ul class="nav nav-tabs mb-3" id="flockTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="daily-tab" data-bs-toggle="tab" data-bs-target="#daily" type="button" role="tab" aria-controls="daily" aria-selected="true">Daily Logs</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="weekly-tab" data-bs-toggle="tab" data-bs-target="#weekly" type="button" role="tab" aria-controls="weekly" aria-selected="false">Weekly Summary</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="hatch-tab" data-bs-toggle="tab" data-bs-target="#hatch" type="button" role="tab" aria-controls="hatch" aria-selected="false">Hatchability Logs</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="charts-tab" data-bs-toggle="tab" data-bs-target="#charts" type="button" role="tab" aria-controls="charts" aria-selected="false">Performance Charts</button>
  </li>
</ul>

<!-- Tab Content -->
<div class="tab-content" id="flockTabsContent">

  <!-- Daily Logs Tab -->
  <div class="tab-pane fade show active" id="daily" role="tabpanel" aria-labelledby="daily-tab">
    <div class="table-responsive table-responsive-sticky">
      <table class="table table-bordered table-sm text-center align-middle" style="font-size: 0.8rem;">
        <thead class="sticky-table-header table-light">
          <tr>
            <th rowspan="2" class="align-middle">Date</th>
            <th rowspan="2" class="align-middle">Age</th>
            <th colspan="2" class="bg-light">Stock</th>
            <th colspan="2" class="bg-danger bg-opacity-10">Mortality</th>
            <th colspan="2" class="bg-warning bg-opacity-10">Culls</th>
            <th rowspan="2" class="align-middle">Feed<br>(Kg)</th>
            <th colspan="2" class="bg-success bg-opacity-10">Feed/Bird<br>(g)</th>
            <th rowspan="2" class="align-middle">Water<br>(ml/bird)</th>
            <th rowspan="2" class="align-middle">Medication</th>
            <th colspan="3" class="bg-info bg-opacity-10">Production</th>
            <th colspan="2">Jumbo</th>
            <th colspan="2">Small</th>
            <th colspan="2">Crack</th>
            <th colspan="2">Abnormal</th>
            <th colspan="2" class="bg-primary bg-opacity-10">Hatching</th>
            <th colspan="2" class="bg-secondary bg-opacity-10">Reject</th>
            <th rowspan="2" class="align-middle">Light<br>(Hr)</th>
          </tr>
          <tr>
            <th class="bg-light">M</th>
            <th class="bg-light">F</th>
            <th class="bg-danger bg-opacity-10">M</th>
            <th class="bg-danger bg-opacity-10">F</th>
            <th class="bg-warning bg-opacity-10">M</th>
            <th class="bg-warning bg-opacity-10">F</th>
            <th class="bg-success bg-opacity-10">M</th>
            <th class="bg-success bg-opacity-10">F</th>
            <th class="bg-info bg-opacity-10">%</th>
            <th class="bg-info bg-opacity-10">Wt(g)</th>
            <th class="bg-info bg-opacity-10">Qty</th>
            <th>#</th>
            <th>%</th>
            <th>#</th>
            <th>%</th>
            <th>#</th>
            <th>%</th>
            <th>#</th>
            <th>%</th>
            <th class="bg-primary bg-opacity-10">#</th>
            <th class="bg-primary bg-opacity-10">%</th>
            <th class="bg-secondary bg-opacity-10">#</th>
            <th class="bg-secondary bg-opacity-10">%</th>
          </tr>
        </thead>
        <tbody>
          {% for item in logs %}
          <tr>
            <td class="text-nowrap fw-bold">{{ item.log.date | date_fmt }}</td>
            <td>W{{ item.log.age_week_day.split('.')[0] }}</td>
            <td class="fw-bold">{{ item.stock_male }}</td>
            <td class="fw-bold">{{ item.stock_female }}</td>
            <td class="{{ 'text-danger fw-bold' if item.log.mortality_male > 0 else 'text-muted' }}">{{ item.log.mortality_male }}</td>
            <td class="{{ 'text-danger fw-bold' if item.log.mortality_female > 0 else 'text-muted' }}">{{ item.log.mortality_female }}</td>
            <td class="{{ 'text-warning fw-bold' if item.log.culls_male > 0 else 'text-muted' }}">{{ item.log.culls_male }}</td>
            <td class="{{ 'text-warning fw-bold' if item.log.culls_female > 0 else 'text-muted' }}">{{ item.log.culls_female }}</td>
            <td class="fw-bold">{{ "%.1f"|format(item.total_feed) }}</td>
            <td>{{ item.log.feed_male_gp_bird }}g</td>
            <td>{{ item.log.feed_female_gp_bird }}g</td>
            {% set total_birds = item.stock_male + item.stock_female %}
            {% set water_per_bird = (item.log.water_intake_calculated * 1000) / total_birds if total_birds > 0 else 0 %}
            <td>{{ "%.0f"|format(water_per_bird) }}</td>
            <td class="text-start small" style="max-width: 120px; white-space: normal; line-height: 1.1;">
                {% if item.medications %}
                    <span class="badge bg-info text-dark">{{ item.medications }}</span>
                {% else %}
                    -
                {% endif %}
            </td>
            <td class="{{ 'bg-success text-white' if item.egg_prod_pct >= 85 else '' }} fw-bold">
                {{ "%.2f"|format(item.egg_prod_pct) }}%
            </td>
            <td>{{ item.log.egg_weight }}</td>
            <td class="fw-bold">{{ item.log.eggs_collected }}</td>
            <td class="small">{{ item.egg_data.jumbo }}</td>
            <td class="text-muted small" style="font-size: 0.75rem;">{{ "%.2f"|format(item.egg_data.jumbo_pct) }}%</td>
            <td class="small">{{ item.egg_data.small }}</td>
            <td class="text-muted small" style="font-size: 0.75rem;">{{ "%.2f"|format(item.egg_data.small_pct) }}%</td>
            <td class="small">{{ item.egg_data.crack }}</td>
            <td class="text-muted small" style="font-size: 0.75rem;">{{ "%.2f"|format(item.egg_data.crack_pct) }}%</td>
            <td class="small">{{ item.egg_data.abnormal }}</td>
            <td class="text-muted small" style="font-size: 0.75rem;">{{ "%.2f"|format(item.egg_data.abnormal_pct) }}%</td>
            <td class="fw-bold text-primary">{{ item.egg_data.hatching }}</td>
            <td class="fw-bold text-primary">{{ "%.2f"|format(item.egg_data.hatching_pct) }}%</td>
            <td class="fw-bold text-danger">{{ item.egg_data.total_culls }}</td>
            <td class="fw-bold text-danger">{{ "%.2f"|format(item.egg_data.total_culls_pct) }}%</td>
            <td>{{ item.lighting_hours }} hour</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Weekly Summary Tab -->
  <div class="tab-pane fade" id="weekly" role="tabpanel" aria-labelledby="weekly-tab">
    {% if weekly_data %}
    <div class="table-responsive table-responsive-sticky mb-4">
      <table class="table table-bordered table-sm">
        <thead class="table-light sticky-table-header">
          <tr>
            <th>Week</th>
            <th>Mortality (M/F)</th>
            <th>Mortality % (M/F)</th>
            <th>Culls (M/F)</th>
            <th>Culls % (M/F)</th>
            <th>Eggs</th>
            <th>Egg Prod %</th>
            <th>Hatching Eggs</th>
            <th>Hatching Egg %</th>
            <th>Avg BW (M/F)</th>
          </tr>
        </thead>
        <tbody>
          {% for w in weekly_data %}
          <tr>
            <td>{{ w.week }}</td>
            <td>{{ w.mortality_male }} / {{ w.mortality_female }}</td>
            <td>{{ "%.2f"|format(w.mort_pct_m) }} / {{ "%.2f"|format(w.mort_pct_f) }}</td>
            <td>{{ w.culls_male }} / {{ w.culls_female }}</td>
            <td>{{ "%.2f"|format(w.cull_pct_m) }} / {{ "%.2f"|format(w.cull_pct_f) }}</td>
            <td>{{ w.eggs }}</td>
            <td>{{ "%.2f"|format(w.egg_prod_pct) }}</td>
            <td>{{ w.hatch_eggs_sum }}</td>
            <td>{{ "%.2f"|format(w.hatching_egg_pct) }}</td>
            <td>{{ w.avg_bw_male }} / {{ w.avg_bw_female }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="text-muted p-3">No weekly data available.</p>
    {% endif %}
  </div>

  <!-- Hatchability Logs Tab -->
  <div class="tab-pane fade" id="hatch" role="tabpanel" aria-labelledby="hatch-tab">
    <div class="table-responsive" style="max-height: 80vh; overflow-y: auto;">
        <table class="table table-striped table-bordered text-center">
            <thead class="table-dark" style="position: sticky; top: 0; z-index: 100;">
                <tr>
                    <th>Setting Date</th>
                    <th>Hatching Date</th>
                    <th>Age (Weeks)</th>
                    <th>Egg Set</th>
                    <th>Hatched</th>
                    <th>Hatch %</th>
                    <th>Hatchable (Fertile)</th>
                    <th>Fertility %</th>
                    <th>Clear %</th>
                    <th>Rotten %</th>
                    <th>Male Ratio %</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for r in hatch_records %}
                <tr>
                    <td>{{ r.setting_date | date_fmt }}</td>
                    <td>{{ r.hatching_date | date_fmt }}</td>
                    <td>{{ ((r.setting_date - flock.intake_date).days // 7) + 1 }}</td>
                    <td>{{ r.egg_set }}</td>
                    <td>{{ r.hatched_chicks }}</td>
                    <td>{{ "%.2f"|format(r.hatchability_pct) }}%</td>
                    <td>{{ r.hatchable_eggs }}</td>
                    <td>{{ "%.2f"|format(r.fertile_egg_pct) }}%</td>
                    <td>{{ "%.2f"|format(r.clear_egg_pct) }}%</td>
                    <td>{{ "%.2f"|format(r.rotten_egg_pct) }}%</td>
                    <td>{{ "%.2f"|format(r.male_ratio_pct) if r.male_ratio_pct is not none else '-' }}%</td>
                    <td>
                        <a href="{{ url_for('hatchability_diagnosis', id=flock.id, date_str=r.setting_date, readonly='true') }}" class="btn btn-sm btn-info text-white" title="Diagnose Farm Data">
                            Diagnose
                        </a>
                    </td>
                </tr>
                {% else %}
                <tr><td colspan="12" class="text-center">No records found.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
  </div>

  <!-- Charts Tab -->
  <div class="tab-pane fade" id="charts" role="tabpanel" aria-labelledby="charts-tab">
    <!-- General Performance Chart -->
    <div class="card mb-4 mt-3">
      <div class="card-header sticky-header d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2">
        <span class="fw-bold mb-2 mb-md-0">General Performance</span>
        <div class="d-flex flex-wrap gap-2">
             <div class="btn-group btn-group-sm" role="group">
                 <input type="radio" class="btn-check" name="chartMode" id="modeDaily" autocomplete="off" checked onchange="switchMode('daily')">
                 <label class="btn btn-outline-secondary" for="modeDaily">Daily</label>

                 <input type="radio" class="btn-check" name="chartMode" id="modeWeekly" autocomplete="off" onchange="switchMode('weekly')">
                 <label class="btn btn-outline-secondary" for="modeWeekly">Weekly</label>
             </div>
             <div class="btn-group btn-group-sm" role="group">
                 <button class="btn btn-outline-secondary" onclick="applyDateFilter('general', 'default')">Default (30d/10w)</button>
                 <button class="btn btn-outline-secondary" onclick="applyDateFilter('general', 'all')">Show All</button>
             </div>
        </div>
      </div>
      <div class="card-body" style="overflow-x: auto;">
        <div style="position: relative; height: 60vh; min-height: 500px; width: 100%; min-width: 800px;">
          <canvas id="generalChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Hatchability Chart -->
    <div class="card mb-4">
      <div class="card-header sticky-header d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2">
        <span class="fw-bold mb-2 mb-md-0">Hatchability & Fertility</span>
        <div class="btn-group btn-group-sm" role="group">
             <button class="btn btn-outline-secondary" onclick="applyDateFilter('hatch', 'default')">Last 10 Weeks</button>
             <button class="btn btn-outline-secondary" onclick="applyDateFilter('hatch', 'all')">Show All</button>
        </div>
      </div>
      <div class="card-body" style="overflow-x: auto;">
        <div style="position: relative; height: 50vh; min-height: 400px; width: 100%; min-width: 800px;">
          <canvas id="hatchChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Male Chart -->
    <div class="card mb-4">
      <div class="card-header sticky-header d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2">
        <span class="fw-bold mb-2 mb-md-0">Male Statistics (BW & Uniformity)</span>
        <div class="btn-group btn-group-sm" role="group">
             <button class="btn btn-outline-secondary" onclick="applyDateFilter('male', 'default')">Last 10 Weeks</button>
             <button class="btn btn-outline-secondary" onclick="applyDateFilter('male', 'all')">Show All</button>
        </div>
      </div>
      <div class="card-body" style="overflow-x: auto;">
        <div style="position: relative; height: 50vh; min-height: 400px; width: 100%; min-width: 800px;">
          <canvas id="maleChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Female Chart -->
    <div class="card mb-4">
      <div class="card-header sticky-header d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2">
          <span class="fw-bold mb-2 mb-md-0">Female Statistics (BW & Uniformity)</span>
          <div class="btn-group btn-group-sm" role="group">
             <button class="btn btn-outline-secondary" onclick="applyDateFilter('female', 'default')">Last 10 Weeks</button>
             <button class="btn btn-outline-secondary" onclick="applyDateFilter('female', 'all')">Show All</button>
          </div>
      </div>
      <div class="card-body" style="overflow-x: auto;">
        <div style="position: relative; height: 50vh; min-height: 400px; width: 100%; min-width: 800px;">
          <canvas id="femaleChart"></canvas>
        </div>
      </div>
    </div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
<script>
  Chart.register(ChartDataLabels);

  const chartDataDaily = {{ chart_data | tojson }};
  const chartDataWeekly = {{ chart_data_weekly | tojson }};
  const hatchRecords = [
      {% for r in hatch_records %}
      {
          date: "{{ r.setting_date | date_fmt }}",
          age: {{ ((r.setting_date - flock.intake_date).days // 7) + 1 }},
          hatch: {{ "%.2f"|format(r.hatchability_pct) }},
          fertile: {{ "%.2f"|format(r.fertile_egg_pct) }},
          clear: {{ "%.2f"|format(r.clear_egg_pct) }},
          rotten: {{ "%.2f"|format(r.rotten_egg_pct) }},
          male_ratio: {{ "%.2f"|format(r.male_ratio_pct) if r.male_ratio_pct is not none else 'null' }},
          // Raw values for aggregation
          egg_set: {{ r.egg_set or 0 }},
          hatched: {{ r.hatched_chicks or 0 }},
          clear_eggs: {{ r.clear_eggs or 0 }},
          rotten_eggs: {{ r.rotten_eggs or 0 }}
      },
      {% endfor %}
  ];
  // Sort by date ASCENDING for chart logic (table is descending)
  hatchRecords.sort((a,b) => new Date(a.date) - new Date(b.date));

  let maleChart, femaleChart, generalChart, hatchChart;
  let currentMode = 'daily';

  // Common Options
  const commonOptions = {
      responsive: true,
      maintainAspectRatio: false,
      spanGaps: true,
      interaction: {
        mode: 'index',
        intersect: false,
      },
      plugins: {
          legend: { position: 'bottom' },
          zoom: {
            zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' },
            pan: { enabled: true, mode: 'x' }
          },
          datalabels: {
              align: 'top',
              anchor: 'end',
              formatter: (v, ctx) => v ? (ctx.dataset.label.includes('%') ? v + '%' : v) : '',
              font: { size: 10, weight: 'bold' },
              color: '#444'
          }
      }
  };

  function getLatestDataIndex(dataArray, checkZero = false) {
      if (!dataArray || dataArray.length === 0) return 0;
      for (let i = dataArray.length - 1; i >= 0; i--) {
          const val = dataArray[i];
          if (val !== null && val !== undefined && (!checkZero || val > 0)) {
              return i;
          }
      }
      return 0;
  }

  function filterData(dataObj, count, metricKey, checkZero=false) {
      if (count === 'all') return dataObj;
      if (!dataObj.dates || dataObj.dates.length === 0) return dataObj;

      let targetArray = dataObj[metricKey];
      if (!targetArray) targetArray = dataObj.dates; // Fallback

      const lastIdx = getLatestDataIndex(targetArray, checkZero);
      let start = lastIdx - count + 1;
      if (start < 0) start = 0;

      const newObj = {};
      for (let key in dataObj) {
          if (Array.isArray(dataObj[key])) {
              // Slice up to lastIdx + 1
              newObj[key] = dataObj[key].slice(start, lastIdx + 1);
          } else {
              newObj[key] = dataObj[key];
          }
      }
      return newObj;
  }

  function getScaleOptions(dataArrays, isPercentage) {
      let allValues = [];
      if (Array.isArray(dataArrays)) {
           // Flatten if array of arrays
           allValues = dataArrays.flat().filter(v => v !== null && v !== undefined && !isNaN(v));
      }

      if (allValues.length === 0) return { min: 0, suggestedMax: isPercentage ? 100 : 10 };

      const maxVal = Math.max(...allValues);
      let limit = maxVal * 1.25;

      if (limit === 0) return { min: 0, suggestedMax: isPercentage ? 100 : 1 };

      if (isPercentage && limit > 100) {
          return { min: 0, max: 100 };
      } else {
          return { min: 0, suggestedMax: limit };
      }
  }

  function renderCharts(mode) {
      currentMode = mode;
      const fullData = mode === 'weekly' ? chartDataWeekly : chartDataDaily;

      // --- Filter Data ---
      const defaultGeneralCount = mode === 'daily' ? 30 : 10;
      const generalLimit = window.generalFilterState || defaultGeneralCount;
      const generalData = filterData(fullData, generalLimit, 'dates');

      const bwLimit = window.bwFilterState || 10;
      // Force Weekly Data for Body Weight Charts (User Request: Show weekly summary only)
      const bwFullData = chartDataWeekly;
      // Use weekly keys specifically
      const bwData = filterData(bwFullData, bwLimit, 'avg_bw_female');

      if (maleChart) maleChart.destroy();
      if (femaleChart) femaleChart.destroy();
      if (generalChart) generalChart.destroy();
      if (hatchChart) hatchChart.destroy();

      // --- Male Chart (Weekly Fixed) ---
      const maleDatasets = [];
      const maleBWValues = []; // Collect for scale calculation

      const maleKey = 'avg_bw_male';
      if (bwData[maleKey] && bwData[maleKey].some(v => v !== null)) {
           maleDatasets.push({
                label: 'Avg BW Male',
                data: bwData[maleKey],
                borderColor: '#000',
                backgroundColor: '#000',
                borderWidth: 2,
                tension: 0.1,
                yAxisID: 'y'
           });
           maleBWValues.push(bwData[maleKey]);
      }

      // Dynamic Partitions removed as requested

      maleDatasets.push({
          label: 'Std BW',
          data: bwData.bw_male_std,
          borderColor: '#000000',
          borderDash: [5, 5],
          pointRadius: 0,
          borderWidth: 1,
          yAxisID: 'y',
          datalabels: { display: false }
      });
      maleBWValues.push(bwData.bw_male_std);

      maleDatasets.push({
          label: 'Uniformity %',
          data: bwData.unif_male,
          borderColor: '#FFCE56',
          borderDash: [2, 2],
          pointStyle: 'rectRot',
          yAxisID: 'y1'
      });

      const maleBWScales = getScaleOptions(maleBWValues, false);
      const maleUniScales = getScaleOptions([bwData.unif_male], true);

      maleChart = new Chart(document.getElementById('maleChart').getContext('2d'), {
        type: 'line',
        data: {
          labels: bwData.dates,
          datasets: maleDatasets
        },
        options: {
            ...commonOptions,
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: { display: true, text: 'Body Weight (g)' },
                    ...maleBWScales
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: { display: true, text: 'Uniformity' },
                    grid: { drawOnChartArea: false },
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    },
                    ...maleUniScales
                }
            }
        }
      });

      // --- Female Chart (Weekly Fixed) ---
      const femaleDatasets = [];
      const femaleBWValues = [];

      const femaleKey = 'avg_bw_female';
      if (bwData[femaleKey] && bwData[femaleKey].some(v => v !== null)) {
           femaleDatasets.push({
                label: 'Avg BW Female',
                data: bwData[femaleKey],
                borderColor: '#000',
                backgroundColor: '#000',
                borderWidth: 2,
                tension: 0.1,
                yAxisID: 'y'
           });
           femaleBWValues.push(bwData[femaleKey]);
      }

      // Dynamic Partitions removed as requested

      femaleDatasets.push({
          label: 'Std BW',
          data: bwData.bw_female_std,
          borderColor: '#000000',
          borderDash: [5, 5],
          pointRadius: 0,
          borderWidth: 1,
          yAxisID: 'y',
          datalabels: { display: false }
      });
      femaleBWValues.push(bwData.bw_female_std);

      femaleDatasets.push({
          label: 'Uniformity %',
          data: bwData.unif_female,
          borderColor: '#9966FF',
          borderDash: [2, 2],
          pointStyle: 'rectRot',
          yAxisID: 'y1'
      });

      const femaleBWScales = getScaleOptions(femaleBWValues, false);
      const femaleUniScales = getScaleOptions([bwData.unif_female], true);

      femaleChart = new Chart(document.getElementById('femaleChart').getContext('2d'), {
        type: 'line',
        data: {
          labels: bwData.dates,
          datasets: femaleDatasets
        },
        options: {
            ...commonOptions,
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: { display: true, text: 'Body Weight (g)' },
                    ...femaleBWScales
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: { display: true, text: 'Uniformity' },
                    grid: { drawOnChartArea: false },
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    },
                    ...femaleUniScales
                }
            }
        }
      });

      // --- General Chart ---
      // X-Axis logic: Daily -> Date, Weekly -> Week Age (Data already has 'dates' array properly formatted as "Week X" for weekly)
      // Wait, general chart X-Axis is requested: "keep daily to date and weekly to their week age".
      // `chartDataWeekly.dates` are "Week X", so that's fine.
      const labels = generalData.dates;

      const mortM = mode==='daily' ? generalData.mortality_daily_male : generalData.mortality_weekly_male;
      const mortF = mode==='daily' ? generalData.mortality_daily_female : generalData.mortality_weekly_female;
      const cullM = mode==='daily' ? generalData.culls_daily_male : generalData.culls_weekly_male;
      const cullF = mode==='daily' ? generalData.culls_daily_female : generalData.culls_weekly_female;

      generalChart = new Chart(document.getElementById('generalChart'), {
          type: 'bar',
          data: {
              labels: labels,
              datasets: [
                  { label: 'Egg Prod %', data: generalData.egg_prod, type:'line', borderColor:'green', yAxisID:'y', datalabels:{align:'bottom'} },
                  { label: 'Std Egg Prod %', data: generalData.std_egg_prod, type:'line', borderColor:'darkgreen', borderDash:[5,5], pointRadius:0, yAxisID:'y', datalabels:{display:false} },

                  // Standard Mortality Lines
                  { label: 'Std Mort Male %', data: generalData.std_mortality_male, type:'line', borderColor:'rgba(54, 162, 235, 0.8)', borderDash:[2,2], pointRadius:0, yAxisID:'y1', datalabels:{display:false} },
                  { label: 'Std Mort Female %', data: generalData.std_mortality_female, type:'line', borderColor:'rgba(255, 99, 132, 0.8)', borderDash:[2,2], pointRadius:0, yAxisID:'y1', datalabels:{display:false} },

                  { label: 'Mort Male %', data: mortM, backgroundColor: 'rgba(54, 162, 235, 0.6)', yAxisID:'y1', datalabels:{display:false} },
                  { label: 'Mort Female %', data: mortF, backgroundColor: 'rgba(255, 99, 132, 0.6)', yAxisID:'y1', datalabels:{display:false} },
                  { label: 'Cull Male %', data: cullM, backgroundColor: 'rgba(255, 206, 86, 0.6)', yAxisID:'y1', datalabels:{display:false} },
                  { label: 'Cull Female %', data: cullF, backgroundColor: 'rgba(75, 192, 192, 0.6)', yAxisID:'y1', datalabels:{display:false} }
              ]
          },
          options: {
              ...commonOptions,
              scales: {
                  y: { type: 'linear', position: 'right', title: {display:true, text:'Egg Prod %'}, min: 0, max: 100 },
                  y1: { type: 'linear', position: 'left', title: {display:true, text:'Mortality/Culls %'}, grid: {drawOnChartArea: false}, min: 0 }
              }
          }
      });

      renderHatchChart();
  }

  function renderHatchChart() {
      // Aggregate hatchRecords by Age Week
      const weeklyHatch = {};

      hatchRecords.forEach(r => {
          // If hatch% is 0, user wants it hidden in "show all" chart.
          // Check if hatch > 0 OR if we should sum everything and check later?
          // "hide when hatchability with 0%".
          // If aggregated week has 0 hatch, hide it.
          // BUT, we need to sum partial data (set eggs) even if not hatched?
          // "only shows chart where hatchability is calculated when chick hatched has been key in"
          // So if hatched_chicks == 0, ignore?
          // If entire week has hatched=0, then hatch%=0.

          const week = "Week " + r.age;
          if (!weeklyHatch[week]) {
              weeklyHatch[week] = { egg_set:0, hatched:0, clear:0, rotten:0, male_ratios:[], age: r.age };
          }
          weeklyHatch[week].egg_set += r.egg_set;
          weeklyHatch[week].hatched += r.hatched;
          weeklyHatch[week].clear += r.clear_eggs;
          weeklyHatch[week].rotten += r.rotten_eggs;
          if (r.male_ratio !== null) weeklyHatch[week].male_ratios.push(r.male_ratio);
      });

      // Convert to array and filter
      let aggregated = [];
      Object.keys(weeklyHatch).forEach(key => {
          const d = weeklyHatch[key];
          if (d.hatched > 0) { // Only valid hatch data
              const es = d.egg_set || 1;
              const hatchPct = (d.hatched / es) * 100;
              const fertilePct = ((d.egg_set - d.clear - d.rotten) / es) * 100;
              const clearPct = (d.clear / es) * 100;
              const rottenPct = (d.rotten / es) * 100;

              let avgMale = null;
              if (d.male_ratios.length > 0) {
                  avgMale = d.male_ratios.reduce((a,b)=>a+b, 0) / d.male_ratios.length;
              }

              aggregated.push({
                  week: key,
                  age: d.age,
                  hatch: parseFloat(hatchPct.toFixed(2)),
                  fertile: parseFloat(fertilePct.toFixed(2)),
                  clear: parseFloat(clearPct.toFixed(2)),
                  rotten: parseFloat(rottenPct.toFixed(2)),
                  male_ratio: avgMale !== null ? parseFloat(avgMale.toFixed(2)) : null
              });
          }
      });

      // Sort by Age
      aggregated.sort((a,b) => a.age - b.age);

      // Filtering (Last 10 Weeks logic)
      const limit = window.hatchFilterState || 10;
      let finalData = aggregated;

      if (limit !== 'all') {
          // Slice last N
          let start = aggregated.length - limit;
          if (start < 0) start = 0;
          finalData = aggregated.slice(start);
      }

      const hLabels = finalData.map(r => r.week);
      const dHatch = finalData.map(r => r.hatch);
      const dFertile = finalData.map(r => r.fertile);
      const dClear = finalData.map(r => r.clear);
      const dRotten = finalData.map(r => r.rotten);
      const dMale = finalData.map(r => r.male_ratio);

      // Max Y Calculation (force 100 if percent)
      // Requirement: "fixed every axis with percentage from 0% to 100%"
      const limitY = 100;

      const ctx = document.getElementById('hatchChart').getContext('2d');
      hatchChart = new Chart(ctx, {
          type: 'bar',
          data: {
              labels: hLabels,
              datasets: [
                  {
                      label: 'Fertile %',
                      data: dFertile,
                      backgroundColor: 'rgba(75, 192, 192, 0.7)',
                      stack: 'Stack 0',
                      order: 2,
                      datalabels: { anchor: 'center', align: 'center', formatter: (v) => v > 0 ? v + '%' : '' }
                  },
                  {
                      label: 'Clear %',
                      data: dClear,
                      backgroundColor: 'rgba(255, 205, 86, 0.7)',
                      stack: 'Stack 0',
                      order: 2,
                      datalabels: { anchor: 'center', align: 'center', formatter: (v) => v > 0 ? v + '%' : '' }
                  },
                  {
                      label: 'Rotten %',
                      data: dRotten,
                      backgroundColor: 'rgba(255, 99, 132, 0.7)',
                      stack: 'Stack 0',
                      order: 2,
                      datalabels: { anchor: 'center', align: 'center', formatter: (v) => v > 0 ? v + '%' : '' }
                  },
                  {
                      label: 'Hatchability %',
                      data: dHatch,
                      type: 'line',
                      borderColor: 'rgba(54, 162, 235, 1)',
                      backgroundColor: 'rgba(54, 162, 235, 0.2)',
                      borderWidth: 3,
                      yAxisID: 'y1',
                      order: 1,
                      datalabels: { anchor: 'start', align: 'bottom', formatter: (v) => v > 0 ? v + '%' : '' }
                  },
                  {
                      label: 'Male Ratio %',
                      data: dMale,
                      type: 'line',
                      borderColor: 'rgba(153, 102, 255, 1)',
                      backgroundColor: 'rgba(153, 102, 255, 0.2)',
                      borderWidth: 2,
                      borderDash: [5, 5],
                      pointStyle: 'circle',
                      yAxisID: 'y1',
                      order: 0,
                      datalabels: { anchor: 'start', align: 'bottom', formatter: (v) => v > 0 ? v + '%' : '' }
                  }
              ]
          },
          options: {
              ...commonOptions,
              scales: {
                  y: {
                      type: 'linear', position: 'left', stacked: true, title: {display:true, text:'Egg Status %'},
                      min: 0, max: 100
                  },
                  y1: {
                      type: 'linear', position: 'right', title: {display:true, text:'Hatchability %'},
                      grid: {drawOnChartArea: false}, min: 0, max: 100
                  }
              }
          }
      });
  }

  function applyDateFilter(chartName, filterType) {
      if (chartName === 'general') {
          window.generalFilterState = (filterType === 'default') ? (currentMode === 'daily' ? 30 : 10) : 'all';
          renderCharts(currentMode);
      } else if (chartName === 'hatch') {
          window.hatchFilterState = (filterType === 'default') ? 10 : 'all';
          // Only re-render hatch chart
          if (hatchChart) hatchChart.destroy();
          renderHatchChart();
      } else {
          // bw
          // Default filter for daily is 10 (days), weekly is 10 (weeks)
          let def = 10;
          window.bwFilterState = (filterType === 'default') ? def : 'all';
          renderCharts(currentMode);
      }
  }

  function switchMode(mode) {
      // Reset general/bw filter when switching mode to default
      window.generalFilterState = (mode === 'daily' ? 30 : 10);
      window.bwFilterState = 10;
      renderCharts(mode);
  }

  document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(el => {
          el.addEventListener('shown.bs.tab', (e) => {
              if (e.target.id === 'charts-tab') {
                  if(maleChart) maleChart.resize();
                  if(femaleChart) femaleChart.resize();
                  if(generalChart) generalChart.resize();
                  if(hatchChart) hatchChart.resize();
              }
          });
      });
      renderCharts('daily');
  });
</script>
{% endblock %}
