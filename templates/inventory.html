{% extends 'base.html' %}

{% block content %}
<h2>Inventory Management</h2>

<div class="row">
    <div class="col-md-12">
        <ul class="nav nav-tabs mb-3" id="inventoryTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="list-tab" data-bs-toggle="tab" data-bs-target="#list" type="button" role="tab">Current Stock</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="transactions-tab" data-bs-toggle="tab" data-bs-target="#transactions" type="button" role="tab">Transaction History</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary" type="button" role="tab">Monthly Summary</button>
            </li>
        </ul>

        <div class="tab-content" id="inventoryTabContent">
            <!-- Current Stock Tab -->
            <div class="tab-pane fade show active" id="list" role="tabpanel">
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Inventory Items</h5>
                        {% if is_admin %}
                        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addItemModal">+ Add New Item</button>
                        {% endif %}
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Type</th>
                                        <th>Batch / Exp</th>
                                        <th>Unit</th>
                                        <th>Stock</th>
                                        <th>Min Level</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in items %}
                                    <tr class="{{ 'table-warning' if item.current_stock < item.min_stock_level else '' }}">
                                        <td>{{ item.name }}</td>
                                        <td>{{ item.type }}</td>
                                        <td>
                                            {% if item.batch_number %}<small class="d-block text-muted">Batch: {{ item.batch_number }}</small>{% endif %}
                                            {% if item.expiry_date %}<small class="d-block text-muted">Exp: {{ item.expiry_date }}</small>{% endif %}
                                        </td>
                                        <td>{{ item.unit }}</td>
                                        <td class="fw-bold">{{ item.current_stock }}</td>
                                        <td>{{ item.min_stock_level }}</td>
                                        <td>
                                            {% if item.current_stock < item.min_stock_level %}
                                                <span class="badge bg-danger">Low Stock</span>
                                            {% else %}
                                                <span class="badge bg-success">OK</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if is_admin %}
                                            <button class="btn btn-sm btn-outline-primary"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#editItemModal{{ item.id }}">Edit</button>
                                            <button class="btn btn-sm btn-outline-success"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#adjustStockModal{{ item.id }}">Adjust</button>
                                            {% else %}
                                            <span class="text-muted small">Read Only</span>
                                            {% endif %}
                                        </td>
                                    </tr>

                                    <!-- Edit Modal -->
                                    <div class="modal fade" id="editItemModal{{ item.id }}" tabindex="-1" aria-hidden="true">
                                        <div class="modal-dialog">
                                            <form action="{{ url_for('edit_inventory_item', id=item.id) }}" method="POST">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title">Edit Item: {{ item.name }}</h5>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <div class="mb-3">
                                                            <label class="form-label">Name</label>
                                                            <input type="text" name="name" class="form-control" value="{{ item.name }}" required>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label class="form-label">Type</label>
                                                            <select name="type" class="form-select">
                                                                <option value="Vaccine" {% if item.type == 'Vaccine' %}selected{% endif %}>Vaccine</option>
                                                                <option value="Medication" {% if item.type == 'Medication' %}selected{% endif %}>Medication</option>
                                                            </select>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label class="form-label">Unit</label>
                                                            <select name="unit" class="form-select">
                                                                <option value="Bottle" {% if item.unit == 'Bottle' %}selected{% endif %}>Bottle</option>
                                                                <option value="Kg" {% if item.unit == 'Kg' %}selected{% endif %}>Kg</option>
                                                                <option value="Packet" {% if item.unit == 'Packet' %}selected{% endif %}>Packet</option>
                                                                <option value="Liter" {% if item.unit == 'Liter' %}selected{% endif %}>Liter</option>
                                                            </select>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label class="form-label">Min Stock Level (Warning Threshold)</label>
                                                            <input type="number" step="0.01" name="min_stock_level" class="form-control" value="{{ item.min_stock_level }}">
                                                        </div>
                                                        <div class="mb-3">
                                                            <label class="form-label">Doses Per Unit (Vaccines)</label>
                                                            <input type="number" name="doses_per_unit" class="form-control" value="{{ item.doses_per_unit or '' }}">
                                                        </div>
                                                        <div class="row">
                                                            <div class="col-md-6 mb-3">
                                                                <label class="form-label">Batch Number</label>
                                                                <input type="text" name="batch_number" class="form-control" value="{{ item.batch_number or '' }}">
                                                            </div>
                                                            <div class="col-md-6 mb-3">
                                                                <label class="form-label">Expiry Date</label>
                                                                <input type="date" name="expiry_date" class="form-control" value="{{ item.expiry_date or '' }}">
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="submit" name="delete" value="1" class="btn btn-danger me-auto" onclick="return confirm('Are you sure you want to delete this item? History will be lost.')">Delete</button>
                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                        <button type="submit" class="btn btn-primary">Save Changes</button>
                                                    </div>
                                                </div>
                                            </form>
                                        </div>
                                    </div>

                                    <!-- Adjust Stock Modal -->
                                    <div class="modal fade" id="adjustStockModal{{ item.id }}" tabindex="-1" aria-hidden="true">
                                        <div class="modal-dialog">
                                            <form action="{{ url_for('inventory_transaction') }}" method="POST">
                                                <input type="hidden" name="inventory_item_id" value="{{ item.id }}">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title">Adjust Stock: {{ item.name }}</h5>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <div class="mb-3">
                                                            <label class="form-label">Transaction Type</label>
                                                            <select name="transaction_type" class="form-select" required>
                                                                <option value="Purchase">Purchase (Add Stock)</option>
                                                                <option value="Usage">Usage (Remove Stock)</option>
                                                                <option value="Adjustment">Adjustment (Correction)</option>
                                                                <option value="Waste">Waste (Remove Stock)</option>
                                                            </select>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label class="form-label">Quantity</label>
                                                            <input type="number" step="0.01" name="quantity" class="form-control" required>
                                                            <small class="text-muted">Enter positive number. 'Usage' and 'Waste' will subtract automatically.</small>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label class="form-label">Date</label>
                                                            <input type="date" name="transaction_date" class="form-control" value="{{ today }}" required>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label class="form-label">Notes</label>
                                                            <input type="text" name="notes" class="form-control">
                                                        </div>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                        <button type="submit" class="btn btn-primary">Submit Transaction</button>
                                                    </div>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Transaction History Tab -->
            <div class="tab-pane fade" id="transactions" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Recent Transactions</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm table-striped">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Item</th>
                                        <th>Type</th>
                                        <th>Quantity</th>
                                        <th>Notes</th>
                                        {% if is_admin %}<th>Actions</th>{% endif %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for t in transactions %}
                                    <tr>
                                        <td>{{ t.transaction_date }}</td>
                                        <td>{{ t.item.name }}</td>
                                        <td>
                                            <span class="badge
                                                {% if t.transaction_type == 'Purchase' %}bg-success
                                                {% elif t.transaction_type == 'Waste' %}bg-danger
                                                {% elif t.transaction_type == 'Usage' %}bg-warning text-dark
                                                {% else %}bg-secondary{% endif %}">
                                                {{ t.transaction_type }}
                                            </span>
                                        </td>
                                        <td>{{ t.quantity }}</td>
                                        <td>{{ t.notes or '' }}</td>
                                        {% if is_admin %}
                                        <td>
                                            <button class="btn btn-sm btn-outline-primary py-0" data-bs-toggle="modal" data-bs-target="#editTransModal{{ t.id }}">Edit</button>
                                            <form action="{{ url_for('delete_inventory_transaction', id=t.id) }}" method="POST" class="d-inline" onsubmit="return confirm('Delete transaction? Stock will be reverted.');">
                                                <button class="btn btn-sm btn-outline-danger py-0">Del</button>
                                            </form>
                                        </td>
                                        {% endif %}
                                    </tr>
                                    {% else %}
                                    <tr><td colspan="{{ '6' if is_admin else '5' }}" class="text-center text-muted">No transactions found.</td></tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Monthly Summary Tab -->
            <div class="tab-pane fade" id="summary" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Monthly Usage Summary ({{ current_month }})</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead>
                                    <tr>
                                        <th>Item</th>
                                        <th>Total Purchased</th>
                                        <th>Total Used</th>
                                        <th>Total Wasted</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for s in summary %}
                                    <tr>
                                        <td>{{ s.name }}</td>
                                        <td class="text-success">+{{ s.purchase }}</td>
                                        <td class="text-warning">-{{ s.usage }}</td>
                                        <td class="text-danger">-{{ s.waste }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Item Modal -->
<div class="modal fade" id="addItemModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <form action="{{ url_for('add_inventory_item') }}" method="POST">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Inventory Item</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <input type="text" name="name" class="form-control" required placeholder="e.g. Vaxxitek">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Type</label>
                        <select name="type" class="form-select">
                            <option value="Vaccine">Vaccine</option>
                            <option value="Medication">Medication</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Unit</label>
                        <select name="unit" class="form-select">
                            <option value="Bottle">Bottle</option>
                            <option value="Kg">Kg</option>
                            <option value="Packet">Packet</option>
                            <option value="Liter">Liter</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Initial Stock</label>
                        <input type="number" step="0.01" name="current_stock" class="form-control" value="0">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Min Stock Level</label>
                        <input type="number" step="0.01" name="min_stock_level" class="form-control" value="0">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Doses Per Unit (If Vaccine)</label>
                        <input type="number" name="doses_per_unit" class="form-control" placeholder="1000">
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Batch Number</label>
                            <input type="text" name="batch_number" class="form-control">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Expiry Date</label>
                            <input type="date" name="expiry_date" class="form-control">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Add Item</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Edit Transaction Modals -->
{% if is_admin %}
{% for t in transactions %}
<div class="modal fade" id="editTransModal{{ t.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <form action="{{ url_for('edit_inventory_transaction', id=t.id) }}" method="POST">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Transaction #{{ t.id }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted">Type: {{ t.transaction_type }} | Item: {{ t.item.name }}</p>
                    <div class="mb-3">
                        <label class="form-label">Quantity (Positive Value)</label>
                        <input type="number" step="0.01" name="quantity" class="form-control" value="{{ t.quantity }}" required>
                        <small class="text-muted">Current Stock will be adjusted by difference.</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Date</label>
                        <input type="date" name="transaction_date" class="form-control" value="{{ t.transaction_date }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <input type="text" name="notes" class="form-control" value="{{ t.notes or '' }}">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </div>
        </form>
    </div>
</div>
{% endfor %}
{% endif %}
{% endblock %}
