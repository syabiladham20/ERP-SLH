{% extends 'base.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Hatchability: {{ flock.house.name }}</h2>
    <a href="{{ url_for('view_flock', id=flock.id) }}" class="btn btn-secondary">Back to Flock</a>
</div>

<div class="card mb-4">
    <div class="card-header">
        <h5>Add Hatchability Record</h5>
    </div>
    <div class="card-body">
        <form method="POST" action="{{ url_for('flock_hatchability', id=flock.id) }}">
            <input type="hidden" name="action" value="add">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Setting Date</label>
                    <input type="date" class="form-control" name="setting_date" id="setting_date" required onchange="updateDates()">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Candling Date (+18d)</label>
                    <input type="date" class="form-control" name="candling_date" id="candling_date" required>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Hatching Date (+21d)</label>
                    <input type="date" class="form-control" name="hatching_date" id="hatching_date" required>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Egg Set</label>
                    <input type="number" class="form-control" name="egg_set" required min="1">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Clear Eggs (Infertile)</label>
                    <input type="number" class="form-control" name="clear_eggs" value="0">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Rotten Eggs (Contaminated)</label>
                    <input type="number" class="form-control" name="rotten_eggs" value="0">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Hatched Chicks</label>
                    <input type="number" class="form-control" name="hatched_chicks" value="0">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Male Ratio % (Optional)</label>
                    <input type="number" step="0.01" class="form-control" name="male_ratio_pct">
                </div>
            </div>
            <div class="mt-3">
                <button type="submit" class="btn btn-primary">Add Record</button>
            </div>
        </form>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-striped table-bordered">
        <thead class="table-dark">
            <tr>
                <th>Setting Date</th>
                <th>Hatching Date</th>
                <th>Age (Weeks)</th>
                <th>Egg Set</th>
                <th>Hatched</th>
                <th>Hatch %</th>
                <th>Hatchable (Fertile)</th>
                <th>Fertility %</th>
                <th>Clear %</th>
                <th>Rotten %</th>
                <th>Male Ratio %</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for r in records %}
            <tr>
                <td>{{ r.setting_date }}</td>
                <td>{{ r.hatching_date }}</td>
                <td>{{ ((r.setting_date - flock.intake_date).days // 7) + 1 }}</td>
                <td>{{ r.egg_set }}</td>
                <td>{{ r.hatched_chicks }}</td>
                <td>{{ "%.2f"|format(r.hatchability_pct) }}%</td>
                <td>{{ r.hatchable_eggs }}</td>
                <td>{{ "%.2f"|format(r.fertile_egg_pct) }}%</td>
                <td>{{ "%.2f"|format(r.clear_egg_pct) }}%</td>
                <td>{{ "%.2f"|format(r.rotten_egg_pct) }}%</td>
                <td>{{ r.male_ratio_pct or '-' }}</td>
                <td>
                    <a href="{{ url_for('hatchability_diagnosis', id=flock.id, date_str=r.setting_date) }}" class="btn btn-sm btn-info text-white" title="Diagnose Farm Data">
                        Diagnose
                    </a>
                    <form method="POST" action="{{ url_for('delete_hatchability', id=flock.id, record_id=r.id) }}" style="display:inline;" onsubmit="return confirm('Delete this record?');">
                        <button type="submit" class="btn btn-sm btn-danger"><i class="bi bi-trash"></i></button>
                    </form>
                </td>
            </tr>
            {% else %}
            <tr><td colspan="12" class="text-center">No records found.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
function updateDates() {
    const setDate = document.getElementById('setting_date').value;
    if (setDate) {
        const d = new Date(setDate);

        const candling = new Date(d);
        candling.setDate(d.getDate() + 18);
        document.getElementById('candling_date').value = candling.toISOString().split('T')[0];

        const hatching = new Date(d);
        hatching.setDate(d.getDate() + 21);
        document.getElementById('hatching_date').value = hatching.toISOString().split('T')[0];
    }
}
</script>
{% endblock %}
